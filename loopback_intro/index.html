<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Rapid REST API development">
<meta property="og:type" content="article">
<meta property="og:title" content="An intro to Loopback">
<meta property="og:url" content="http://tcmal.xyz/loopback_intro/index.html">
<meta property="og:site_name" content="tcmal">
<meta property="og:description" content="Rapid REST API development">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://dev-to-uploads.s3.amazonaws.com/i/6cv3wz3xlzziwc9mc9v8.png">
<meta property="article:published_time" content="2020-04-05T11:00:00.000Z">
<meta property="article:modified_time" content="2020-11-19T15:58:36.734Z">
<meta property="article:author" content="tcmal">
<meta property="article:tag" content="loopback">
<meta property="article:tag" content="server">
<meta property="article:tag" content="rest">
<meta property="article:tag" content="api">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dev-to-uploads.s3.amazonaws.com/i/6cv3wz3xlzziwc9mc9v8.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>An intro to Loopback</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a href="https://github.com/tcmal" target="_blank" rel="noopener">GitHub</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/xss-done-right/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/pagination/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://tcmal.xyz/loopback_intro/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://tcmal.xyz/loopback_intro/&text=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://tcmal.xyz/loopback_intro/&is_video=false&description=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=An intro to Loopback&body=Check out this article: http://tcmal.xyz/loopback_intro/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://tcmal.xyz/loopback_intro/&name=An intro to Loopback&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://tcmal.xyz/loopback_intro/&t=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Models"><span class="toc-number">1.</span> <span class="toc-text">Models</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Controllers"><span class="toc-number">2.</span> <span class="toc-text">Controllers</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Authentication"><span class="toc-number">3.</span> <span class="toc-text">Authentication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        An intro to Loopback
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">tcmal</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-04-05T11:00:00.000Z" itemprop="datePublished">2020-04-05</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Web-Development/">Web Development</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/api/" rel="tag">api</a>, <a class="tag-link" href="/tags/loopback/" rel="tag">loopback</a>, <a class="tag-link" href="/tags/rest/" rel="tag">rest</a>, <a class="tag-link" href="/tags/server/" rel="tag">server</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Loopback is a Typescript framework for REST APIs. Not for web apps, nor for websockets (though it can be adapted to both of those) - Specifically for REST APIs. Whilst this seems like a limitation, focusing on this one specific area means that many parts are streamlined for quick development, while also having all the flexibility (and layers of abstraction) of an enterprise application.</p>
<p>So here’s a lightning fast tour of how to make an API.</p>
<h1 id="Models"><a href="#Models" class="headerlink" title="Models"></a>Models</h1><p>To keep the actual code seperated from wherever we store our data, there’s 2 layers of seperation between our Models and where we store them.</p>
<p>In brief, a <code>DataSource</code> (such as an SQL server), is used by a <code>Repository</code> to get our <code>Model</code>s.</p>
<p>Luckily, a lot of this is already done for us. All we need to do is use the <code>lb4</code> command line tool to generate it.</p>
<p>First, make a project:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> $ npm install -g @loopback&#x2F;cli</span><br><span class="line"> $ lb4 frogger-back</span><br><span class="line">? Project description: frogger-back</span><br><span class="line">? Project root directory: frogger-back</span><br><span class="line">? Application class name: FroggerApplication</span><br><span class="line">? Select features to enable in the project (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection) Enable eslint, Enable loopbackB</span><br><span class="line">uild, Enable docker, Enable repositories, Enable services</span><br></pre></td></tr></table></figure>

<p>There’s an easy TUI behind this so it’s easy to make it do what you want.<br>Now we need to make our DataSource. For now, we’ll just use the in-memory database. It’ll also save our data to a JSON file (which you should remember to gitignore).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> $ lb4 datasource</span><br><span class="line">? Datasource name: TestDB</span><br><span class="line">? Select the connector for TestDB: In-memory db (supported by StrongLoop)</span><br><span class="line">? window.localStorage key to use for persistence (browser only): </span><br><span class="line">? Full path to file for persistence (server only): .&#x2F;data&#x2F;db.json</span><br><span class="line">   create src&#x2F;datasources&#x2F;test-db.datasource.config.json</span><br></pre></td></tr></table></figure>

<p>Now let’s scaffold out a model. We even get our properties added for us.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> $ lb4 model</span><br><span class="line">? Model class name: User</span><br><span class="line">? Please select the model base class Entity (A persisted model with an ID)</span><br><span class="line">? Allow additional (free-form) properties? No</span><br><span class="line">Model User will be created in src&#x2F;models&#x2F;user.model.ts</span><br><span class="line"></span><br><span class="line">Let&#39;s add a property to User</span><br><span class="line">Enter an empty property name when done</span><br><span class="line"></span><br><span class="line">? Enter the property name: name</span><br><span class="line">? Property type: string</span><br><span class="line">? Is name the ID property? Yes</span><br><span class="line">? Is name generated automatically? No</span><br><span class="line">? Is it required?: Yes</span><br><span class="line">? Default value [leave blank for none]: </span><br><span class="line"></span><br><span class="line">Let&#39;s add another property to User</span><br><span class="line">Enter an empty property name when done</span><br><span class="line"></span><br><span class="line">? Enter the property name: email</span><br><span class="line">? Property type: string</span><br><span class="line">? Is it required?: No</span><br><span class="line">? Default value [leave blank for none]: </span><br><span class="line"></span><br><span class="line"> [...]</span><br></pre></td></tr></table></figure>

<p>Now we make our repository that gets Users from the datastore.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> $ lb4 repository</span><br><span class="line">? Please select the datasource: TestDbDatasource</span><br><span class="line">? Select the model(s) you want to generate a repository: User</span><br><span class="line">? Please select the repository base class: DefaultCrudRepository (Legacy juggler bridge)</span><br></pre></td></tr></table></figure>

<p>While we’re at it, we can define some extra validation. Not only does this add it to our model, it also adds it to the input validation on our routes AND to the API docs loopback generates.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> User <span class="keyword">extends</span> Entity &#123;</span><br><span class="line">  <span class="meta">@property</span>(&#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">'string'</span>,</span><br><span class="line">    id: <span class="literal">true</span>,</span><br><span class="line">    generated: <span class="literal">false</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    jsonSchema: &#123;</span><br><span class="line">      maxLength: <span class="number">24</span>,</span><br><span class="line">      minLength: <span class="number">4</span>,</span><br><span class="line">      pattern: <span class="string">'^[A-z0-9\-_]+$'</span>,</span><br><span class="line">      errorMessage: <span class="string">"Username should be between 4 and 24 alphanumeric characters"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@property</span>(&#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">'string'</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    generated: <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br><span class="line">  password: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@property</span>(&#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">'string'</span>,</span><br><span class="line">    required: <span class="literal">false</span>,</span><br><span class="line">    jsonSchema: &#123;</span><br><span class="line">      <span class="keyword">type</span>: <span class="string">'email'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  email?: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h1 id="Controllers"><a href="#Controllers" class="headerlink" title="Controllers"></a>Controllers</h1><p>Now we need to actually handle some routes. For that, we use a controller. Like our models, we can generate this automatically, and even make standard CRUD routes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> $ lb4 controller</span><br><span class="line">? Controller class name: User</span><br><span class="line">Controller User will be created in src&#x2F;controllers&#x2F;user.controller.ts</span><br><span class="line"></span><br><span class="line">? What kind of controller would you like to generate? REST Controller with CRUD functions</span><br><span class="line">? What is the name of the model to use with this CRUD repository? User</span><br><span class="line">? What is the name of your CRUD repository? UserRepository</span><br><span class="line">? What is the name of ID property? name</span><br><span class="line">? What is the type of your ID? string</span><br><span class="line">? Is the id omitted when creating a new instance? Yes</span><br><span class="line">? What is the base HTTP path name of the CRUD operations? &#x2F;users</span><br></pre></td></tr></table></figure>

<p>For some variety, let’s look at the automatic docs loopback generates. When we start the server, they’re available at <code>localhost:3000/explorer</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm start</span><br></pre></td></tr></table></figure>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/6cv3wz3xlzziwc9mc9v8.png" alt="API Docs"></p>
<p>So we get count, get all, get detail, 2 versions of update 1, update many and delete. Here’s a quick reference of what a route looks like, specifically the create route:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@post</span>(<span class="string">'/users'</span>, &#123;</span><br><span class="line">  responses: &#123;</span><br><span class="line">    <span class="string">'200'</span>: &#123;</span><br><span class="line">      description: <span class="string">'User model instance'</span>,</span><br><span class="line">      content: &#123;<span class="string">'application/json'</span>: &#123;schema: getModelSchemaRef(User)&#125;&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">async</span> create(</span><br><span class="line">  <span class="meta">@requestBody</span>(&#123;</span><br><span class="line">    content: &#123;</span><br><span class="line">      <span class="string">'application/json'</span>: &#123;</span><br><span class="line">        schema: getModelSchemaRef(User, &#123;</span><br><span class="line">          title: <span class="string">'NewUser'</span>,</span><br><span class="line">          exclude: [<span class="string">'createdAt'</span>],</span><br><span class="line">        &#125;),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">  user: Omit&lt;User, <span class="string">'created_at'</span>&gt;,</span><br><span class="line">): <span class="built_in">Promise</span>&lt;User&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.userRepository.create(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All we have is a function with a decorator - our first part (<code>@post</code>), defines the types of responses our route will give. Right now our only one is a successful one, which returns an <code>application/json</code> response. Loopback lets us generate a schema from our model, so if we’re successful we’ll just return a User.</p>
<p>The next important part is <code>@requestBody</code>, which tells loopback our argument comes from the request body. It’s also used to generate documentation. Again, we use <code>getModelSchemaRef</code> to give us our User schema, but this time we give it a custom title and exclude a field.</p>
<p>All this work does have a payoff - This defines all the validation for our request body (or, more accurately, inherits it from User), as well as adding it to our docs. Loopback exposes these docs as an <a href="https://swagger.io/docs/specification/about/" target="_blank" rel="noopener">OpenAPI</a> file or as an online playground (which we’ll probably want to disable in production).</p>
<p>We’re not limited to standard CRUD routes though - Here’s a custom route with a body to give you an idea of how the schema objects work.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@requestBody</span>(&#123;</span><br><span class="line">  content: &#123;</span><br><span class="line">    <span class="string">'application/json'</span>: &#123;</span><br><span class="line">      schema: &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'object'</span>,</span><br><span class="line">        required: [<span class="string">'username'</span>, <span class="string">'password'</span>],</span><br><span class="line">        properties: &#123;</span><br><span class="line">          username: &#123;</span><br><span class="line">            <span class="keyword">type</span>: <span class="string">'string'</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          password: &#123;</span><br><span class="line">            <span class="keyword">type</span>: <span class="string">'string'</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h1><p>Authentication seems like a lot of code to set up, this is mostly because of the layers of abstraction we’ll use in it. We implement interfaces defined in <code>@loopback/authentication</code> and <code>@loopback/security</code>.</p>
<p>Specifically, we’ll implement a <code>TokenService</code> that converts a token to/from a UserProfile. Then, we’ll implement a <code>UserService</code> that can convert a UserProfile to a User and vice versa, as well as being able to verify credentials and return a User.</p>
<p>So, when we login a user we need to:</p>
<ul>
<li>Verify their credentials, returning a User (UserService)</li>
<li>Convert that User to a UserProfile (UserService)</li>
<li>Generate a token for that UserProfile (TokenService)</li>
</ul>
<p>Then, to see the logged in user of a request:</p>
<ul>
<li>Convert their token to a UserProfile (TokenService)</li>
<li>Convert that profile to a User (UserService)</li>
</ul>
<p>I chose to implement JWT and use the <code>UserRepository</code>. Here’s my <a href="https://github.com/tcmal/frogger-back/blob/master/src/services/jwt.service.ts" target="_blank" rel="noopener">TokenService</a> and <a href="https://github.com/tcmal/frogger-back/blob/master/src/services/user.service.ts" target="_blank" rel="noopener">UserService</a>. Hopefully they’re pretty self-explanatory.</p>
<p>Now we need to make sure we use the same service everywhere. But what’s the point of all our abstraction if we hard-wire one class. So we’ll use a ‘binding’ to tell anywhere we need it what we’re using for each service.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> TOKEN_SERVICE = BindingKey.create&lt;TokenService&gt;(</span><br><span class="line">  <span class="string">'services.authentication.jwt.tokenservice'</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>then we bind a class to it in <code>application.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.bind(TokenServiceBindings.TOKEN_SERVICE).toClass(JWTService);</span><br></pre></td></tr></table></figure>

<p>Now our controllers can just ask for whatever’s in that binding to be injected. So we’ll get the same token service every time.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="meta">@inject</span>(TokenServiceBindings.TOKEN_SERVICE)</span></span><br><span class="line"><span class="params">  <span class="keyword">public</span> tokenService: TokenService,</span></span><br></pre></td></tr></table></figure>

<p>Finally, here’s the actual code we need for issuing a token:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.userService.verifyCredentials(creds);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> profile = <span class="keyword">this</span>.userService.convertToUserProfile(user);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> token = <span class="keyword">await</span> <span class="keyword">this</span>.tokenService.generateToken(profile);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  token,</span><br><span class="line">  user</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now to verify it we need to plug in an <code>AuthenticationStrategy</code>, which just gets our Authentication from a request.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> JWTAuthenticationStrategy <span class="keyword">implements</span> AuthenticationStrategy &#123;</span><br><span class="line">  name = <span class="string">'jwt'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@inject</span>(TokenServiceBindings.TOKEN_SERVICE)</span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> tokenService: TokenService,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> authenticate(request: Request): <span class="built_in">Promise</span>&lt;UserProfile | <span class="literal">undefined</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> token: <span class="built_in">string</span> = <span class="keyword">this</span>.extractCredentials(request);</span><br><span class="line">    <span class="keyword">const</span> userProfile: UserProfile = <span class="keyword">await</span> <span class="keyword">this</span>.tokenService.verifyToken(token);</span><br><span class="line">    <span class="keyword">return</span> userProfile;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  extractCredentials(request: Request): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!request.headers.authorization) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpErrors.Unauthorized(<span class="string">`Authorization header not found.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> authHeaderValue = request.headers.authorization;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that if someone’s authentication fails we throw an <code>HttpError</code>, which is automatically converted to an actual HTTP response. This is the general pattern for user errors, meaning most of our code is focused on the success case.</p>
<p>Anyway, we register our authentication strategy in <code>application.ts</code>:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.component(AuthenticationComponent);</span><br><span class="line">registerAuthenticationStrategy(<span class="keyword">this</span>, JWTAuthenticationStrategy);</span><br></pre></td></tr></table></figure>

<p>Now, FINALLY, when we want to protect a route we just set our authentication strategy and ask for our profile to be injected.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@authenticate</span>(<span class="string">'jwt'</span>)</span><br><span class="line"><span class="keyword">async</span> create(</span><br><span class="line">  <span class="meta">@inject</span>(SecurityBindings.USER)</span><br><span class="line">  profile: UserProfile,</span><br></pre></td></tr></table></figure>

<p>Now it’s in our docs and we get nice error messages for bad tokens, without polluting our actual controller functions.</p>
<p>This was a really brief description of the setup that skimmed over a lot of parts. If you’re confused, you can read the <a href="https://loopback.io/doc/en/lb4/Authentication-Tutorial.html" target="_blank" rel="noopener">official tutorial</a> or check out <a href="https://github.com/tcmal/frogger-back" target="_blank" rel="noopener">my code</a></p>
<p>There’s a similar Service/Binding setup for password hashing when we register (or you could hardwire it if you want). Rather than repeating myself, <a href="https://github.com/tcmal/frogger-back/blob/master/src/services/passhash.service.ts" target="_blank" rel="noopener">I’ll just link to the code</a>.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Once you get past the learning curve and mediocre docs, loopback does make it really fast to develop APIs. And, thanks to the time we spent on abstraction, It’ll be much easier to switch out parts if your application needs to grow, for example using a different session store than JWT or caching things by overriding parts of the repository.</p>
<p><a href="https://github.com/tcmal/frogger-back/" target="_blank" rel="noopener">Here’s my code</a> if you want some clarification, or head to <a href="https://loopback.io/" target="_blank" rel="noopener">loopback.io</a> if you want to learn more.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a href="https://github.com/tcmal" target="_blank" rel="noopener">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Models"><span class="toc-number">1.</span> <span class="toc-text">Models</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Controllers"><span class="toc-number">2.</span> <span class="toc-text">Controllers</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Authentication"><span class="toc-number">3.</span> <span class="toc-text">Authentication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://tcmal.xyz/loopback_intro/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://tcmal.xyz/loopback_intro/&text=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://tcmal.xyz/loopback_intro/&is_video=false&description=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=An intro to Loopback&body=Check out this article: http://tcmal.xyz/loopback_intro/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://tcmal.xyz/loopback_intro/&title=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://tcmal.xyz/loopback_intro/&name=An intro to Loopback&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://tcmal.xyz/loopback_intro/&t=An intro to Loopback" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2020
    tcmal
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a href="https://github.com/tcmal" target="_blank" rel="noopener">GitHub</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
