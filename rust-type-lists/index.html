<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Recently, I’ve been working on a more modular framework for game engines. Essentially, you need only implement a DrawPass, which takes in some context and renders to the given frame. 12345678910111213">
<meta property="og:type" content="article">
<meta property="og:title" content="Rust Type Lists">
<meta property="og:url" content="http://tcmal.xyz/rust-type-lists/index.html">
<meta property="og:site_name" content="tcmal">
<meta property="og:description" content="Recently, I’ve been working on a more modular framework for game engines. Essentially, you need only implement a DrawPass, which takes in some context and renders to the given frame. 12345678910111213">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-08-13T23:00:00.000Z">
<meta property="article:author" content="tcmal">
<meta property="article:tag" content="Rust">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Rust Type Lists</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/tcmal">GitHub</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/asymmetric-encryption/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://tcmal.xyz/rust-type-lists/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://tcmal.xyz/rust-type-lists/&text=Rust Type Lists"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://tcmal.xyz/rust-type-lists/&is_video=false&description=Rust Type Lists"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Rust Type Lists&body=Check out this article: http://tcmal.xyz/rust-type-lists/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://tcmal.xyz/rust-type-lists/&name=Rust Type Lists&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://tcmal.xyz/rust-type-lists/&t=Rust Type Lists"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Decided-at-runtime"><span class="toc-number">1.</span> <span class="toc-text">Decided at runtime</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Recursive-definition"><span class="toc-number">2.</span> <span class="toc-text">Recursive definition</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Positional-awareness"><span class="toc-number">3.</span> <span class="toc-text">Positional awareness</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Benchmarking"><span class="toc-number">4.</span> <span class="toc-text">Benchmarking</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bonus-A-simple-macro-for-ConsDrawPass"><span class="toc-number">5.</span> <span class="toc-text">Bonus: A simple macro for ConsDrawPass</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Rust Type Lists
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">tcmal</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-08-13T23:00:00.000Z" itemprop="datePublished">2021-08-14</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Software-Development/">Software Development</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Rust/" rel="tag">Rust</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Recently, I’ve been working on a more modular framework for game engines. Essentially, you need only implement a <code>DrawPass</code>, which takes in some context and renders to the given frame.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">DrawPass</span></span> &#123;</span><br><span class="line">    <span class="comment">// Simplified. This would probably contain the game state, a command buffer, and the image view to draw to.</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MapDrawPass</span></span> &#123;</span><br><span class="line">    camera_fov: <span class="built_in">f32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> DrawPass <span class="keyword">for</span> MapDrawPass &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        todo!()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This works great for simple scenes, but it’s not very flexible. Most modern games have different parts to drawing that happen one after the other. For example, the level is drawn, then the viewmodels on top, and then the UI. In some cases, we also apply effects to the whole screen, such as ‘night vision’ or ‘nausea’.</p>
<p>However, in the interest of simplifying the framework code, it would be easier to pretend there’s only one draw pass as much as we can. After all, from its perspective it only needs to get an image to draw to, give it to the draw pass, then present it to the screen.</p>
<h1 id="Decided-at-runtime"><a href="#Decided-at-runtime" class="headerlink" title="Decided at runtime"></a>Decided at runtime</h1><p>Here’s a somewhat naive approach where we simply throw it in a list:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ManyDrawPasses</span></span>(<span class="built_in">Vec</span>&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> DrawPass&gt;&gt;);</span><br><span class="line"><span class="keyword">impl</span> DrawPass <span class="keyword">for</span> ManyDrawPasses &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="keyword">self</span>.<span class="number">0</span>.iter() &#123;</span><br><span class="line">            p.render()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">One</span></span>;</span><br><span class="line"><span class="keyword">impl</span> DrawPass <span class="keyword">for</span> One &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> dp = ManyDrawPasses ( <span class="built_in">vec!</span>[One, Two, Three] )</span><br><span class="line">    dp.render(); <span class="comment">// 1 2 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is pretty simple, and easy to use, but has some downsides. Besides the overhead of a <code>Vec</code>, the line <code>p.render()</code> is actually deceptively complex. It needs to:</p>
<ol>
<li>Dereference the borrow to a Box</li>
<li>Dereference the Box to get a vtable address</li>
<li>Look up this vtable address, plus a specific offset to get the function’s address.</li>
<li>Call this function</li>
</ol>
<p>On a modern system, this is almost certainly negligible. But, since this is being called every frame, there’s no harm in seeing how we can make it faster.</p>
<p>Luckily, Rust lets us have zero-cost generics, meaning that as long as we can know the type of each <code>p</code> at compile time, it can be just like any other function call.<br>As long as we’re ok with deciding our draw passes at compile time, we can make this work.</p>
<h1 id="Recursive-definition"><a href="#Recursive-definition" class="headerlink" title="Recursive definition"></a>Recursive definition</h1><p>Although rust doesn’t have native support for lists of types defined at compile time, we can use a recursive definition of a list to get the same effect.</p>
<p>Essentially, every list is either a single element (in which case we just pass it in directly), or it’s one element, then another list (or single element for the end).</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ConsDrawPass</span></span>&lt;A, B&gt; &#123;</span><br><span class="line">    a: A,</span><br><span class="line">    b: B,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;A: DrawPass, B: DrawPass&gt; DrawPass <span class="keyword">for</span> ConsDrawPass&lt;A, B&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.a.render();</span><br><span class="line">        <span class="keyword">self</span>.b.render();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> dp = ConsDrawPass &#123; a: One, b: Two &#125;;</span><br><span class="line">    dp.render(); <span class="comment">// 1 2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dp2 = ConsDrawPass &#123; a: One, b: ConsDrawPass &#123; a: Two, b: Three &#125; &#125;;</span><br><span class="line">    dp.render(); <span class="comment">// 1 2 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So, we have our compile-time sized list, and once the compiler comes in to optimise it, we have it with zero cost.</p>
<h1 id="Positional-awareness"><a href="#Positional-awareness" class="headerlink" title="Positional awareness"></a>Positional awareness</h1><p>It might happen that you need the first element called to do something special, or the end. For instance, in Vulkan the image we draw to starts in <code>Layout::Undefined</code>, should probably be passed from the first to the 2nd in <code>Layout::ColorAttachmentOptimal</code>, and needs to come out the end in <code>Layout::Present</code>.</p>
<p>Whilst we can easily add code between each element by putting it in <code>ConsDrawPass</code>, we can’t really have stuff specifically at the beginning or end without modifying our framework.<br>Let’s try letting our draw passes know roughly where they are with a type enum.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In practice you would probably seal this trait.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">PassPosition</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Beginning</span></span>;</span><br><span class="line"><span class="keyword">impl</span> PassPosition <span class="keyword">for</span> Beginning &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Middle</span></span>;</span><br><span class="line"><span class="keyword">impl</span> PassPosition <span class="keyword">for</span> Middle &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">End</span></span>;</span><br><span class="line"><span class="keyword">impl</span> PassPosition <span class="keyword">for</span> End &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Our renderer code expects to call DrawPass&lt;Singular&gt;, and ignores everything else.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Singular</span></span>;</span><br><span class="line"><span class="keyword">impl</span> PassPosition <span class="keyword">for</span> Singular &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">DrawPass</span></span>&lt;P: PassPosition&gt; &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">One</span></span>;</span><br><span class="line"><span class="keyword">impl</span>&lt;P: PassPosition&gt; DrawPass&lt;P&gt; <span class="keyword">for</span> One &#123; <span class="comment">// Implemented for any position</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;1 &#123;&#125;&quot;</span>, std::any::type_name::&lt;P&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> dp = One;</span><br><span class="line">    DrawPass::&lt;Singular&gt;::render(&amp;dp); <span class="comment">// 1 Singular</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This works well. We can even implement <code>DrawPass</code> for only one position, if we’re sure something should only be at the start or the end.<br>But what about our <code>ConsDrawPass</code>? Well, we could just add some more generic arguments:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ConsDrawPass</span></span>&lt;A, B, AP, BP&gt; &#123;</span><br><span class="line">    a: A,</span><br><span class="line">    b: B,</span><br><span class="line">    _d: PhantomData&lt;(AP, BP)&gt;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;A, B, AP, BP, P&gt; DrawPass&lt;P&gt; <span class="keyword">for</span> ConsDrawPass&lt;A, B, AP, BP&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    A: DrawPass&lt;AP&gt;,</span><br><span class="line">    AP: PassPosition,</span><br><span class="line">    B: DrawPass&lt;BP&gt;,</span><br><span class="line">    BP: PassPosition,</span><br><span class="line">    P: PassPosition,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.a.render();</span><br><span class="line">        <span class="keyword">self</span>.b.render();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> dp: ConsDrawPass&lt;One, ConsDrawPass&lt;Two, Three, Middle, End&gt;, Beginning, Middle&gt; =</span><br><span class="line">        ConsDrawPass &#123;</span><br><span class="line">            a: One,</span><br><span class="line">            b: ConsDrawPass &#123;</span><br><span class="line">                a: Two,</span><br><span class="line">                b: Three,</span><br><span class="line">                _d: PhantomData,</span><br><span class="line">            &#125;,</span><br><span class="line">            _d: PhantomData,</span><br><span class="line">        &#125;;</span><br><span class="line">    DrawPass::&lt;Singular&gt;::render(&amp;dp); <span class="comment">// 1 Beginning 2 Middle 3 End</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And it works but… yikes. Not only is there nothing stopping us from putting our beginning middle and ends wherever we like, but we have to specify all the types ourselves. Let’s start back at the beginning.</p>
<p>We know that the outermost <code>ConsDrawPass</code> is the one that’s being asked to render. Since our renderer is always calling <code>DrawPass::&lt;Singular&gt;::render</code>, We know that whenever <code>DrawPass&lt;Singular&gt;</code> is used, <code>a</code> is at the beginning. Let’s consider 2 items, the minimal case, for now, and just say the last one is at the end.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span>&lt;A, B&gt; DrawPass&lt;Singular&gt; <span class="keyword">for</span> ConsDrawPass&lt;A, B&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    A: DrawPass&lt;Beginning&gt;,</span><br><span class="line">    B: DrawPass&lt;End&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we also need this to work for larger lists. Assuming we’re only ever going to use <code>ConsDrawPass</code> as the second element, we know it will be called with <code>DrawPass&lt;End&gt;</code>. For a 3 element list, we know <code>a</code> should be <code>Middle</code> and <code>b</code> should be <code>End</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;A, B&gt; DrawPass&lt;End&gt; <span class="keyword">for</span> ConsDrawPass&lt;A, B&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    A: DrawPass&lt;Middle&gt;,</span><br><span class="line">    B: DrawPass&lt;End&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, if we imagine <code>b</code> is another <code>ConsDrawPass</code>, we know it’s going to be called with <code>End</code> again, and so will do the same thing. This means our positions should be inferred for any size list we like!</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> dp = ConsDrawPass &#123;</span><br><span class="line">        a: One,</span><br><span class="line">        b: ConsDrawPass &#123;</span><br><span class="line">            a: Two,</span><br><span class="line">            b: ConsDrawPass &#123; a: Three, b: Four &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    DrawPass::&lt;Singular&gt;::render(&amp;dp); <span class="comment">// 1 Beginning 2 Middle 3 Middle 4 End</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dp2 = ConsDrawPass &#123; a: One, b: Two &#125;;</span><br><span class="line">    DrawPass::&lt;Singular&gt;::render(&amp;dp2); <span class="comment">// 1 Beginning 2 End</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Perfect! Rust’s type system lets the requirements for each implementation ‘bubble upwards’, and we only need to specify that we’re starting with a <code>Singular</code> for everything to fall into place.</p>
<h1 id="Benchmarking"><a href="#Benchmarking" class="headerlink" title="Benchmarking"></a>Benchmarking</h1><p>It’s not too hard to reimplement our runtime approach (although this could definitely be done better)</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ManyDrawPasses</span></span> (<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> DrawPass&lt;Beginning&gt;&gt;, <span class="built_in">Vec</span>&lt;<span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> DrawPass&lt;Middle&gt;&gt;&gt;, <span class="built_in">Box</span>&lt;<span class="keyword">dyn</span> DrawPass&lt;End&gt;&gt;);</span><br><span class="line"><span class="keyword">impl</span> DrawPass&lt;Singular&gt; <span class="keyword">for</span> ManyDrawPasses &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">render</span></span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span>.render();</span><br><span class="line">        <span class="keyword">for</span> dp <span class="keyword">in</span> <span class="keyword">self</span>.<span class="number">1</span>.iter() &#123;</span><br><span class="line">            dp.render();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">2</span>.render();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>With this, we can run some quick benchmarks of this against our <code>ConsDrawPass</code> approach.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">     Running unittests (target&#x2F;release&#x2F;deps&#x2F;type_lists-f5135a770feae075)</span><br><span class="line"></span><br><span class="line">running 2 tests</span><br><span class="line">test compile::bench::compiled_bench ... bench:         292 ns&#x2F;iter (+&#x2F;- 7)</span><br><span class="line">test naive::bench::naive_bench      ... bench:         350 ns&#x2F;iter (+&#x2F;- 4)</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured; 0 filtered out; finished in 1.40s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>As we might expect, there’s very little difference. Whether or not this is worth the more complicated code is definitely up for debate, but hopefully this was at least interesting. The full code is <a target="_blank" rel="noopener" href="https://github.com/tcmal/rust-type-lists">here</a>.</p>
<h1 id="Bonus-A-simple-macro-for-ConsDrawPass"><a href="#Bonus-A-simple-macro-for-ConsDrawPass" class="headerlink" title="Bonus: A simple macro for ConsDrawPass"></a>Bonus: A simple macro for <code>ConsDrawPass</code></h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> consdrawpass &#123;</span><br><span class="line">    ($x:expr) =&gt; &#123; $x &#125;;</span><br><span class="line">    ($x:expr, $($y:expr),+) =&gt; &#123; ConsDrawPass &#123; a: $x, b: consdrawpass!($($y),*)&#125; &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">consdrawpass!(One, Two, Three, Four);</span><br><span class="line"><span class="comment">// ConsDrawPass &#123;a: One, b: ConsDrawPass &#123;a: Two, b: ConsDrawPass &#123;a: Three, b: Four&#125;&#125;&#125;;</span></span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/tcmal">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Decided-at-runtime"><span class="toc-number">1.</span> <span class="toc-text">Decided at runtime</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Recursive-definition"><span class="toc-number">2.</span> <span class="toc-text">Recursive definition</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Positional-awareness"><span class="toc-number">3.</span> <span class="toc-text">Positional awareness</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Benchmarking"><span class="toc-number">4.</span> <span class="toc-text">Benchmarking</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bonus-A-simple-macro-for-ConsDrawPass"><span class="toc-number">5.</span> <span class="toc-text">Bonus: A simple macro for ConsDrawPass</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://tcmal.xyz/rust-type-lists/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://tcmal.xyz/rust-type-lists/&text=Rust Type Lists"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://tcmal.xyz/rust-type-lists/&is_video=false&description=Rust Type Lists"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Rust Type Lists&body=Check out this article: http://tcmal.xyz/rust-type-lists/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://tcmal.xyz/rust-type-lists/&title=Rust Type Lists"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://tcmal.xyz/rust-type-lists/&name=Rust Type Lists&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://tcmal.xyz/rust-type-lists/&t=Rust Type Lists"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2022
    tcmal
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/archives/">Recent</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/tcmal">GitHub</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
