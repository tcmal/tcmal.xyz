<!DOCTYPE html5>
<html>
	<head>
		<title>recover-document | Holiday Hack 2019</title>
		<link rel="stylesheet" href="/css/common.css">
		<link rel="stylesheet" href="/css/writeup.css">
		<link rel="stylesheet" href="/css/pygments.css">
		<link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
		
		<meta charset="utf-8" />
	</head>
	<body>
		<main>
			<h1>Recover cleartext document</h1>
<p>We're given a <code>.exe</code> file, <code>.pdb</code> file, and an encrypted PDF file.</p>
<p>We can start by loading up the <code>.exe</code> file and reversing it. I did this using ghidra. It's important to import the <code>.pdb</code> file before you run auto-analysis, otherwise it'll mess stuff up. Luckily the <code>.pdb</code> files do a bunch of the work for us.</p>
<p>First, let's figure out what the encryption does. Ghidra's built-in decompiler does a great job of the <code>do_encrypt</code> function, here's it cleaned up a bit.</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">do_encrypt</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">param_2</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">param_3</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* [variable declarations] */</span>
    <span class="cm">/* [stack protections] */</span>
    <span class="n">puVar1</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">param_2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_8</span><span class="p">);</span>
    <span class="n">puVar1</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="n">puVar1</span><span class="p">,</span><span class="n">local_8</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="n">iVar2</span> <span class="o">=</span> <span class="n">CryptAcquireContextA</span>
                <span class="p">(</span><span class="o">&amp;</span><span class="n">local_10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0xf0000000</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fatal_error</span><span class="p">(</span><span class="s">&quot;CryptAcquireContext failed&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">generate_key</span><span class="p">((</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_1c</span><span class="p">);</span>
    <span class="n">print_hex</span><span class="p">(</span><span class="s">&quot;Generated an encryption key&quot;</span><span class="p">,(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_1c</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">local_30</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">local_2f</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">local_2e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">local_2c</span> <span class="o">=</span> <span class="mh">0x6601</span><span class="p">;</span>
    <span class="n">local_28</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">local_24</span> <span class="o">=</span> <span class="n">local_1c</span><span class="p">;</span>
    <span class="n">local_20</span> <span class="o">=</span> <span class="n">local_18</span><span class="p">;</span>
    <span class="n">iVar2</span> <span class="o">=</span> <span class="n">CryptImportKey</span><span class="p">(</span><span class="n">local_10</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_30</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_c</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fatal_error</span><span class="p">(</span><span class="s">&quot;CryptImportKey failed for DES-CBC key&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">iVar2</span> <span class="o">=</span> <span class="n">CryptEncrypt</span><span class="p">(</span><span class="n">local_c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">puVar1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_8</span><span class="p">,</span><span class="n">local_8</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iVar2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fatal_error</span><span class="p">(</span><span class="s">&quot;CryptEncrypt failed&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">store_key</span><span class="p">(</span><span class="n">param_1</span><span class="p">,(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_1c</span><span class="p">);</span>
    <span class="n">iVar2</span> <span class="o">=</span> <span class="n">__iob_func</span><span class="p">(</span><span class="s">&quot;File successfully encrypted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="cm">/* [print some ascii art] */</span>
    <span class="n">write_file</span><span class="p">(</span><span class="n">param_3</span><span class="p">,</span><span class="n">puVar1</span><span class="p">,</span><span class="n">local_8</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">puVar1</span><span class="p">);</span>

    <span class="cm">/* [stack protections] */</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>So it's using Microsoft's built-in encryption with a key from <code>generate_key(&amp;buffer)</code>. From the error message we also know it's using <code>DES-CBC</code>. DES is deprecated cos the key sizes are comparatively small, but it's still never been completely cracked. This means we need to figure out the key, presumably by figuring out the random seed used.</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">generate_key</span><span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="n">param_1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">local_8</span><span class="p">;</span>

    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">__iob_func</span><span class="p">(</span><span class="s">&quot;Our miniature elves are putting together random bits for your secretkey!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">iVar1</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>

    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">super_secure_srand</span><span class="p">(</span><span class="n">iVar1</span><span class="p">);</span>

    <span class="n">local_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">local_8</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">iVar1</span> <span class="o">=</span> <span class="n">super_secure_random</span><span class="p">();</span>
        <span class="n">param_1</span><span class="p">[</span><span class="n">local_8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)</span><span class="n">iVar1</span><span class="p">;</span>
        <span class="n">local_8</span> <span class="o">=</span> <span class="n">local_8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">super_secure_srand</span><span class="p">(</span><span class="kt">int</span> <span class="n">param_1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">iVar1</span><span class="p">;</span>
    <span class="n">iVar1</span> <span class="o">=</span> <span class="n">__iob_func</span><span class="p">(</span><span class="s">&quot;Seed = %d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">param_1</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">iVar1</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>

    <span class="n">RAND_SEED</span> <span class="o">=</span> <span class="n">param_1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">super_secure_random</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RAND_SEED</span> <span class="o">=</span> <span class="n">RAND_SEED</span> <span class="o">*</span> <span class="mh">0x343fd</span> <span class="o">+</span> <span class="mh">0x269ec3</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">RAND_SEED</span> <span class="o">&gt;&gt;</span> <span class="mh">0x10</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>The initial seed is just the result of <code>time()</code> which is the unix timestamp, ie the number of seconds since 01/01/1970 00:00:00AM. The challenge text also tells us it was encrypted <code>06/12/2019 19:00 - 21:00 UTC</code>, converted to unix time:</p>
<div class="codehilite"><pre><span></span>Start = 1575658800
End = 1575666000
N = 7200
</pre></div>


<p>Now we need to be able to generate the key given any seed. I used python to re-create the logic of <code>generate_key()</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">getKey</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">*</span> <span class="mh">0x343fd</span>
        <span class="n">seed</span> <span class="o">+=</span> <span class="mh">0x269ec3</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>

        <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">seed</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="k">return</span> <span class="n">buf</span>
</pre></div>


<p>We need a couple more <code>&amp;</code>s since python won't limit our integer sizes like C does. Now we can brute-force the encrypted file. <code>pycryptodome</code> is the most common module for this, so we just use its inbuilt <code>DES-CBC</code>.</p>
<p>We're pretty sure it's a pdf file, which means the first 4 bytes are <code>25 50 44 46</code> or <code>%PDF</code>. We just need to try all the seeds in our range and find one where the first 4 bytes are <code>%PDF</code>.</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">DES</span>

<span class="c1"># Read the file</span>
<span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;file.enc&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">encrypted</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">encsample</span> <span class="o">=</span> <span class="n">encrypted</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span> <span class="c1"># Only do the first bit</span>

<span class="c1"># Bruteforce</span>
<span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1575658800</span><span class="p">,</span> <span class="mi">1575666001</span><span class="p">):</span>
    <span class="c1"># Get the key</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">getKey</span><span class="p">(</span><span class="n">seed</span><span class="p">)])</span>

    <span class="c1"># Try decrypting</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">DES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0\0\0\0\0\0\0\0</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encsample</span><span class="p">)</span>

    <span class="c1"># Validity check</span>
    <span class="k">if</span> <span class="n">dec</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;%PDF&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; --- FOUND&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>

        <span class="c1"># Now decrypt the full file</span>
        <span class="n">cipher</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">DES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0\0\0\0\0\0\0\0</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fulldec</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;out.pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fulldec</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span>$ python brute.py
 --- FOUND
1575663650 b&#39;%PDF-1.3\n%\xc4\xe5\xf2\xe5\xeb\xa7&#39;
</pre></div>


<p>Now we have the decrypted file and can read it. The cover subheading is <code>Machine Learning Sleigh Route Finder</code>.</p>
		</main>

		<footer>
			<div class="links">
				<div>
					<a aria-label="Back" href="index.html">
						<span class="iconify" data-icon="fa:arrow-left"></span>
					</a>
				</div>
				<div>
			</div>
		</footer>

		<script src="https://code.iconify.design/1/1.0.3/iconify.min.js"></script>
	</body>
</html>